<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2. Collect Empirical Data for Forecasting â€¢ AMPHForecastSuite</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Collect Empirical Data for Forecasting">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">AMPHForecastSuite</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01-getting-started.html">1. Getting Started with AMPH Forecast Suite</a></li>
    <li><a class="dropdown-item" href="../articles/02-collect_empirical_data.html">2. Collect Empirical Data for Forecasting</a></li>
    <li><a class="dropdown-item" href="../articles/03-times-series-models.html">3. Forecasting with Time Series Models</a></li>
    <li><a class="dropdown-item" href="../articles/04-utilizing-hub-output.html">4. Ensembling, Visualization, and Scoring Forecasting Outputs</a></li>
    <li><a class="dropdown-item" href="../articles/05-convert_file_types.html">Other: Converting File Types</a></li>
    <li><a class="dropdown-item" href="../articles/nowcasting-demo.html">Other: Introduction to panel data versioning and nowcasting</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ACCIDDA/AMPH_Forecast_Suite/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>2. Collect Empirical Data for Forecasting</h1>
            <h3 data-toc-skip class="subtitle">Using NHSN
Hospitalization Data</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ACCIDDA/AMPH_Forecast_Suite/blob/main/vignettes/02-collect_empirical_data.Rmd" class="external-link"><code>vignettes/02-collect_empirical_data.Rmd</code></a></small>
      <div class="d-none name"><code>02-collect_empirical_data.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="set-parameters">Set parameters<a class="anchor" aria-label="anchor" href="#set-parameters"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_name</span> <span class="op">&lt;-</span> <span class="st">"Maryland"</span></span>
<span><span class="va">geo_ids</span> <span class="op">&lt;-</span> <span class="st">"md"</span></span>
<span><span class="va">forecast_disease</span> <span class="op">&lt;-</span> <span class="st">"influenza"</span></span>
<span><span class="va">forecast_date</span> <span class="op">=</span> <span class="st">"2024-12-01"</span> <span class="co">#"2025-10-12" # Sunday</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-packages">Load packages<a class="anchor" aria-label="anchor" href="#load-packages"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html" class="external-link">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>echo <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ACCIDDA/AMPH_Forecast_Suite" class="external-link">AMPHForecastSuite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jeroen.r-universe.dev/jsonlite" class="external-link">jsonlite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epidatr/" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epiprocess" class="external-link">epiprocess</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="save-and-check-api-key">Save and check API key<a class="anchor" aria-label="anchor" href="#save-and-check-api-key"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Go to <a href="https://api.delphi.cmu.edu/epidata/admin/registration_form" class="external-link uri">https://api.delphi.cmu.edu/epidata/admin/registration_form</a>
and register for a psuedo-anonymous account.</p></li>
<li><p>Run the command below to save your API key in your
<code>.Renviron</code> file. As it says in the prompt, add a line
<code>DELPHI_EPIDATA_KEY=yourkeyhere</code> to your
<code>.Renviron</code> file. Save and close the file, then restart R or
RStudio. After restarting, run the command
<code><a href="https://cmu-delphi.github.io/epidatr/reference/get_api_key.html" class="external-link">epidatr::get_api_key()</a></code> to check that your API key is
saved.</p></li>
</ol>
<p>If the API key does not come, you can use this one until it comes:
<code>04e7369e1541a</code></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Follow instructions about opening `.Renviron` file</span></span>
<span><span class="fu">epidatr</span><span class="fu">::</span><span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/get_api_key.html" class="external-link">save_api_key</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check that the API key is saved</span></span>
<span><span class="fu">epidatr</span><span class="fu">::</span><span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/get_api_key.html" class="external-link">get_api_key</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="pull-nhsn-hospitalization-data">Pull NHSN hospitalization data<a class="anchor" aria-label="anchor" href="#pull-nhsn-hospitalization-data"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_nhsn_data.html">get_nhsn_data</a></span><span class="op">(</span></span>
<span>  disease <span class="op">=</span> <span class="va">forecast_disease</span>, <span class="co">#"influenza"  or "rsv" or "covid"</span></span>
<span>  geo_values <span class="op">=</span> <span class="va">geo_ids</span>,</span>
<span>  forecast_date <span class="op">=</span> <span class="va">forecast_date</span>,</span>
<span>  save_data <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Important: forecast_date is more than 1 week ago. Pulling data issued prior to forecast_date.</span></span></code></pre>
<pre><code><span><span class="co">## Pulling data issued on or before 2024-12-01</span></span></code></pre>
<pre><code><span><span class="co">## Warning: No API key found. You will be limited to non-complex queries and encounter rate</span></span>
<span><span class="co">## limits if you proceed.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">â„¹</span> See `?save_api_key()` for details on obtaining and setting API keys.</span></span>
<span><span class="co">## <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span></code></pre>
</div>
<div class="section level2">
<h2 id="or-pull-directly-with-epidatr">Or pull directly with epidatr<a class="anchor" aria-label="anchor" href="#or-pull-directly-with-epidatr"></a>
</h2>
<p>Note: To pull data directly that pertains to a previous forecast
date, you need to filter by issue date. The code below is not set up to
do that, so it will pull the most recent data. To pull data as of a
previous forecast date, use the <code><a href="../reference/get_nhsn_data.html">get_nhsn_data()</a></code> function
above.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Map disease names to NHSN signal names</span></span>
<span><span class="co"># Based on epidatr NHSN signals for respiratory diseases</span></span>
<span><span class="va">signal_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"influenza"</span> <span class="op">=</span> <span class="st">"confirmed_admissions_flu_ew"</span>,</span>
<span>  <span class="st">"covid"</span> <span class="op">=</span> <span class="st">"confirmed_admissions_covid_ew"</span>,</span>
<span>  <span class="st">"rsv"</span> <span class="op">=</span> <span class="st">"confirmed_admissions_rsv_ew"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">signal</span> <span class="op">&lt;-</span> <span class="va">signal_map</span><span class="op">[[</span><span class="va">forecast_disease</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Call epidatr to get the data</span></span>
<span><span class="va">target_data</span> <span class="op">&lt;-</span> <span class="fu">epidatr</span><span class="fu">::</span><span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"nhsn"</span>,</span>
<span>  signals <span class="op">=</span> <span class="va">signal</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"week"</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="va">geo_ids</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">target_data</span> <span class="op">&lt;-</span> <span class="va">target_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">&gt;=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span><span class="st">"2020-09-01"</span><span class="op">)</span>,</span>
<span>                <span class="va">time_value</span> <span class="op">&lt;</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span><span class="va">forecast_date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>disease <span class="op">=</span> <span class="va">forecast_disease</span>, signal <span class="op">=</span> <span class="va">signal</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">source</span>, <span class="va">disease</span>, <span class="va">signal</span>, issue_date <span class="op">=</span> <span class="va">issue</span>, <span class="va">time_value</span>, <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert to match hubverse</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"loc_data"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">target_data</span> <span class="op">&lt;-</span> <span class="va">target_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>abbreviation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>target_end_date <span class="op">=</span> <span class="va">time_value</span> <span class="op">+</span> <span class="fl">6</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"wk inc "</span>, <span class="va">disease</span>, <span class="st">" hosp"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">loc_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">abbreviation</span>, <span class="va">location</span>, <span class="va">location_name</span><span class="op">)</span>,</span>
<span>                   by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"abbreviation"</span> <span class="op">=</span> <span class="st">"abbreviation"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">target_end_date</span>, <span class="va">location_name</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">location</span>, <span class="va">abbreviation</span>, <span class="va">location_name</span>, <span class="va">target</span>, <span class="va">source</span>, <span class="va">disease</span>, <span class="va">signal</span>,</span>
<span>                <span class="va">target_end_date</span>, <span class="va">issue_date</span>, observation <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="check-the-data">Check the data<a class="anchor" aria-label="anchor" href="#check-the-data"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">target_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_end_date</span>, y <span class="op">=</span> <span class="va">observation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">location_name</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"NHSN Hospital Admissions"</span><span class="op">)</span>,</span>
<span>       x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Weekly hospital admissions (n)"</span>,</span>
<span>       alt <span class="op">=</span> <span class="st">"Line plot of weekly hospital admissions over time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="02-collect_empirical_data_files/figure-html/unnamed-chunk-3-1.png" alt="Line plot of weekly hospital admissions over time" width="700"></p>
</div>
<div class="section level3">
<h3 id="save-it">Save it<a class="anchor" aria-label="anchor" href="#save-it"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">target_data</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"target-data"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"target-hospital-admissions-"</span>, <span class="va">forecast_date</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by ACCIDDA.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
