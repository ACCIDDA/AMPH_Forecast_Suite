<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2b: Introduction to panel data versioning and nowcasting • AMPHForecastSuite</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2b: Introduction to panel data versioning and nowcasting">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">AMPHForecastSuite</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01-getting-started.html">1. Getting Started with AMPH Forecast Suite</a></li>
    <li><a class="dropdown-item" href="../articles/02-collect_empirical_data.html">2. Collect Empirical Data for Forecasting</a></li>
    <li><a class="dropdown-item" href="../articles/02.1-nowcasting-demo.html">2b: Introduction to panel data versioning and nowcasting</a></li>
    <li><a class="dropdown-item" href="../articles/03-times-series-models.html">3. Forecasting with Time Series Models</a></li>
    <li><a class="dropdown-item" href="../articles/04-utilizing-hub-output.html">4. Ensembling, Visualization, and Scoring Forecasting Outputs</a></li>
    <li><a class="dropdown-item" href="../articles/05-convert_file_types.html">Other: Converting File Types</a></li>
    <li><a class="dropdown-item" href="../articles/06-existing-forecast-hubs.html">6. Existing Forecast and Scenario Projection Hubs</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ACCIDDA/AMPH_Forecast_Suite/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>2b: Introduction to panel data versioning and nowcasting</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ACCIDDA/AMPH_Forecast_Suite/blob/main/vignettes/02.1-nowcasting-demo.Rmd" class="external-link"><code>vignettes/02.1-nowcasting-demo.Rmd</code></a></small>
      <div class="d-none name"><code>02.1-nowcasting-demo.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette walks through a minimal baseline nowcasting workflow
using the <code>baselinenowcast</code> and <code>epinowcast</code>
packages. We focus on weekly confirmed hospital admissions attributed to
influenza in Maryland and illustrate how to: - retrieve revision-aware
surveillance data, - build a reporting triangle, - estimate a reporting
delay distribution, and - generate a deterministic point nowcast that
corrects for under-reporting.</p>
<p>We repeat these steps with data from the baselinenowcast
documentation.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>We assume you have followed the first guide of this course, and have
an API key ready for the DELPHI Epidata API.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">epidatr</span><span class="fu">::</span><span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/get_api_key.html" class="external-link">get_api_key</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We will nowcast the confirmed hospital admission for influenza in
Maryland. We specify the date at which we are nowcasting, and the date
with the final data for evaluation.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_name</span> <span class="op">&lt;-</span> <span class="st">"Maryland"</span></span>
<span><span class="va">geo_values</span> <span class="op">&lt;-</span> <span class="st">"md"</span></span>
<span><span class="va">forecast_disease</span> <span class="op">&lt;-</span> <span class="st">"influenza"</span></span>
<span><span class="va">nowcast_date</span> <span class="op">=</span> <span class="st">"2025-02-10"</span></span>
<span><span class="va">eval_date</span> <span class="op">=</span> <span class="st">"2025-03-21"</span></span></code></pre></div>
<p>Load the required packages.</p>
</div>
<div class="section level2">
<h2 id="retrieve-and-prepare-surveillance-data">Retrieve and Prepare Surveillance Data<a class="anchor" aria-label="anchor" href="#retrieve-and-prepare-surveillance-data"></a>
</h2>
<p>Use <code><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">epidatr::pub_covidcast()</a></code> to pull National Healthcare
Safety Network (NHSN) hospital admission data for the selected disease
and location. The data are returned with revision tracking
(<code>issue</code>) that we rely on for nowcasting.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Map disease names to NHSN signal names</span></span>
<span>  <span class="co"># Based on epidatr NHSN signals for respiratory diseases</span></span>
<span>  <span class="va">signal_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"influenza"</span> <span class="op">=</span> <span class="st">"confirmed_admissions_flu_ew"</span>,</span>
<span>    <span class="st">"covid"</span> <span class="op">=</span> <span class="st">"confirmed_admissions_covid_ew"</span>,</span>
<span>    <span class="st">"rsv"</span> <span class="op">=</span> <span class="st">"confirmed_admissions_rsv_ew"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">signal</span> <span class="op">&lt;-</span> <span class="va">signal_map</span><span class="op">[[</span><span class="va">forecast_disease</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Call epidatr to get the data</span></span>
<span>  <span class="va">epidata</span> <span class="op">&lt;-</span> <span class="fu">epidatr</span><span class="fu">::</span><span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="st">"nhsn"</span>,</span>
<span>    signals <span class="op">=</span> <span class="va">signal</span>,</span>
<span>    geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>    time_type <span class="op">=</span> <span class="st">"week"</span>,</span>
<span>    geo_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="va">geo_values</span><span class="op">)</span>,</span>
<span>    issues <span class="op">=</span> <span class="st">"*"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: No API key found. You will be limited to non-complex queries and encounter rate</span></span>
<span><span class="co">## limits if you proceed.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> See `?save_api_key()` for details on obtaining and setting API keys.</span></span>
<span><span class="co">## <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">target_data</span> <span class="op">&lt;-</span> <span class="va">epidata</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>      location <span class="op">=</span> <span class="va">geo_value</span>,</span>
<span>      reference_date <span class="op">=</span> <span class="va">time_value</span>,</span>
<span>      report_date <span class="op">=</span> <span class="va">issue</span>,</span>
<span>      confirm <span class="op">=</span> <span class="va">value</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">enw_filter_report_dates</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="va">eval_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">enw_filter_reference_dates</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="va">nowcast_date</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="va">target_data</span><span class="op">$</span><span class="va">report_date</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "2024-11-17" "2024-11-24" "2024-12-01" "2024-12-08" "2024-12-15"</span></span>
<span><span class="co">##  [6] "2024-12-22" "2024-12-29" "2025-01-05" "2025-01-12" "2025-01-19"</span></span>
<span><span class="co">## [11] "2025-01-26" "2025-02-02" "2025-02-09" "2025-02-16" "2025-02-23"</span></span>
<span><span class="co">## [16] "2025-03-02" "2025-03-09" "2025-03-16"</span></span></code></pre>
<p>Here we have transformed the data so it is in the format for
epinowcast, with columns * <code>reference_date</code> the date of the
observation, in this example the date of an incident influenza admission
in a hospital * <code>report_date</code>: the date of report for a given
set of observations by reference date * <code>confirm</code>: the total
(i.e. cumulative) number of hospitalisations by reference date and
report date.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_data</span></span></code></pre></div>
<pre><code><span><span class="co">##       location reference_date report_date confirm</span></span>
<span><span class="co">##         &lt;char&gt;         &lt;IDat&gt;      &lt;IDat&gt;   &lt;num&gt;</span></span>
<span><span class="co">##    1:       md     2020-08-02  2024-11-17      NA</span></span>
<span><span class="co">##    2:       md     2020-08-02  2024-11-24      NA</span></span>
<span><span class="co">##    3:       md     2020-08-02  2024-12-01      NA</span></span>
<span><span class="co">##    4:       md     2020-08-02  2024-12-08      NA</span></span>
<span><span class="co">##    5:       md     2020-08-02  2024-12-15      NA</span></span>
<span><span class="co">##   ---                                            </span></span>
<span><span class="co">## 4171:       md     2025-02-09  2025-02-16    1035</span></span>
<span><span class="co">## 4172:       md     2025-02-09  2025-02-23    1081</span></span>
<span><span class="co">## 4173:       md     2025-02-09  2025-03-02    1081</span></span>
<span><span class="co">## 4174:       md     2025-02-09  2025-03-09    1081</span></span>
<span><span class="co">## 4175:       md     2025-02-09  2025-03-16    1081</span></span></code></pre>
<p>Create two views of the data: the real-time version available on the
nowcast date and the final version used for evaluation. This use very
convenient filtering functions in epinowcast. The epinowcast function
<code><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">epinowcast::enw_latest_data()</a></code> filters observations to keep
only the latest available reported total counts for each reference date.
The epinowcast function
<code><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">epinowcast::enw_filter_report_dates()</a></code> is used to create a
truncated dataset for generating a retrospective nowcast, using the data
that would have been available as of the nowcast date.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">observed_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">enw_filter_report_dates</a></span><span class="op">(</span><span class="va">target_data</span>, latest_date <span class="op">=</span> <span class="va">nowcast_date</span><span class="op">)</span></span>
<span><span class="va">obs_by_reference</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">enw_latest_data</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">latest_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">enw_latest_data</a></span><span class="op">(</span><span class="va">target_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">enw_filter_reference_dates</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">$</span><span class="va">reference_date</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let’s plot our two datasets, the red line shows the total number of
confirmed admissions on each reference date, across all delays, using
the data available at the nowcast date, whereas the blackline show the
final value of the data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_data_by_reference_date</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">enw_latest_data</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">obs_data_by_reference_date</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"darkred"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">latest_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#scale_y_continuous(trans = "log10") +</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-11-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">nowcast_date</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparing real-time and later observed cases"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;ggplot2::labels&gt; List of 1</span></span>
<span><span class="co">##  $ title: chr "Comparing real-time and later observed cases"</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 222 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">## (`geom_line()`).</span></span>
<span><span class="co">## Removed 222 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">## (`geom_line()`).</span></span></code></pre>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-2-1.png" width="700">
We see that some revision occurred ! Let’s try to fix these.</p>
<div class="section level3">
<h3 id="visualizing-all-versions-on-the-same-plot">Visualizing all versions on the same plot<a class="anchor" aria-label="anchor" href="#visualizing-all-versions-on-the-same-plot"></a>
</h3>
<p>Now let’s create a plot showing all different report date versions in
different colors on the same graph. This helps us understand how the
data evolved over time as new reports came in.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get all unique report dates to create snapshots</span></span>
<span><span class="va">all_report_dates</span> <span class="op">&lt;-</span> <span class="va">target_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">report_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a dataframe with the latest data available as of each report date</span></span>
<span><span class="co"># Using epinowcast::enw_latest_data() to properly get the latest value for each reference date</span></span>
<span><span class="va">all_versions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">all_report_dates</span>, <span class="kw">function</span><span class="op">(</span><span class="va">rd</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">target_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">enw_filter_report_dates</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="va">rd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">enw_latest_data</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">rd</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create plot with all versions in different colors</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all_versions</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">confirm</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"All Data Versions by Report Date"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Each color represents the data as it appeared on a different report date"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Report Date"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_d</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>, end <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>        legend.key.height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-11-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">nowcast_date</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 3996 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">## (`geom_line()`).</span></span></code></pre>
<p><img src="02.1-nowcasting-demo_files/figure-html/plot-all-versions-1.png" width="700"></p>
<p>This plot shows how the reported values for each reference date
changed over time as more complete data became available. Earlier
versions (earlier colors in the legend) show lower values due to
reporting delays, while later versions show progressively higher and
more complete counts.</p>
</div>
</div>
<div class="section level2">
<h2 id="build-the-reporting-triangle">Build the Reporting Triangle<a class="anchor" aria-label="anchor" href="#build-the-reporting-triangle"></a>
</h2>
<p>Restrict the data to a training window and construct the reporting
triangle, which stores rows of reference weeks and columns of reporting
delays.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Empirical data outside this delay window will not be used for training</span></span>
<span><span class="va">max_delay</span> <span class="op">&lt;-</span> <span class="fl">4</span> <span class="co"># weeks</span></span>
<span><span class="va">n_training_volume</span> <span class="op">&lt;-</span> <span class="fl">8</span><span class="op">*</span><span class="fl">7</span> <span class="co"># days (30 weeks)</span></span></code></pre></div>
<p>Next we will use the epinowcast function,
<code><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">epinowcast::enw_filter_reference_dates()</a></code> to filter to only
include n_training_volume days of historical data, and the epinowcast
function <code><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">epinowcast::enw_latest_data()</a></code> will be used to
filter for the latest available reported total counts for each reference
date. Finally to obtain the data we want to evaluate the forecasts
against, we will use epinowcast::enw_filter_reference_dates() applied to
the target_data, to filter it for only the n_training_volume days of
historical data.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">training_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">enw_filter_reference_dates</a></span><span class="op">(</span><span class="va">observed_data</span>, include_days <span class="op">=</span> <span class="va">n_training_volume</span><span class="op">)</span></span>
<span></span>
<span><span class="va">latest_training_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">enw_latest_data</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eval_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">enw_filter_reference_dates</a></span><span class="op">(</span><span class="va">latest_data</span>, include_days <span class="op">=</span> <span class="va">n_training_volume</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pobs</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_preprocess_data.html" class="external-link">enw_preprocess_data</a></span><span class="op">(</span></span>
<span>  obs <span class="op">=</span> <span class="va">training_data</span>,</span>
<span>  max_delay <span class="op">=</span> <span class="va">max_delay</span><span class="op">+</span><span class="fl">2</span>,</span>
<span>  timestep<span class="op">=</span><span class="st">"week"</span>,</span>
<span>  set_negatives_to_zero <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: The coverage of the specified maximum delay could not be reliably checked.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">•</span> There are only very few (4) reference dates that are sufficiently far in the</span></span>
<span><span class="co">##   past (more than 27 days) to compute coverage statistics for the maximum</span></span>
<span><span class="co">##   delay.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">•</span> You can test different maximum delays and obtain coverage statistics using</span></span>
<span><span class="co">##   the function check_max_delay() (`?epinowcast::check_max_delay()`).</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reporting_triangle_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>  <span class="va">pobs</span><span class="op">$</span><span class="va">new_confirm</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">reference_date</span>,</span>
<span>  <span class="va">delay</span>,</span>
<span>  <span class="va">new_confirm</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">reporting_triangle</span> <span class="op">&lt;-</span> <span class="va">reporting_triangle_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">delay</span>, values_from <span class="op">=</span> <span class="va">new_confirm</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reporting_triangle</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">reporting_triangle</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">reporting_triangle</span></span></code></pre></div>
<pre><code><span><span class="co">##        0  1 2 3 4</span></span>
<span><span class="co">## [1,]  94 37 0 0 0</span></span>
<span><span class="co">## [2,] 134 44 0 0 0</span></span>
<span><span class="co">## [3,] 367 40 0 0 0</span></span>
<span><span class="co">## [4,] 366  0 0 6 0</span></span>
<span><span class="co">## [5,] 459  0 0 0 0</span></span>
<span><span class="co">## [6,] 582  0 0 0 0</span></span>
<span><span class="co">## [7,] 770 40 0 0 0</span></span>
<span><span class="co">## [8,] 962  0 0 0 0</span></span></code></pre>
<p>Look at the output of the triangle, what do you notice ?</p>
<p>Inspect the reporting triangle using a heat map.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#### code to plot:</span></span>
<span><span class="va">triangle_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">reporting_triangle</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">time</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span>,</span>
<span>    names_prefix <span class="op">=</span> <span class="st">"V"</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"delay"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">delay</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_triangle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">triangle_df</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="va">time</span>, fill <span class="op">=</span> <span class="va">count</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Reporting triangle"</span>, x <span class="op">=</span> <span class="st">"Delay"</span>, y <span class="op">=</span> <span class="st">"Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_triangle</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-6-1.png" width="700">
Here, the grey indicates matrix elements that are NA, which we would
expect to be the case in the bottom right portion of the reporting
triangle where the counts have yet to be observed.</p>
</div>
<div class="section level2">
<h2 id="estimate-delay-and-generate-point-nowcasts">Estimate Delay and Generate Point Nowcasts<a class="anchor" aria-label="anchor" href="#estimate-delay-and-generate-point-nowcasts"></a>
</h2>
<p>We use half of the available reference weeks to estimate the delay
distribution and reserve the remaining weeks for evaluation.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># most recent 50% of the reference times for delay estimation</span></span>
<span><span class="va">n_history_delay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">n_training_volume</span><span class="op">)</span> <span class="co"># days</span></span>
<span></span>
<span><span class="va">delay_pmf</span> <span class="op">&lt;-</span> <span class="fu">baselinenowcast</span><span class="fu">::</span><span class="fu"><a href="https://baselinenowcast.epinowcast.org/reference/estimate_delay.html" class="external-link">estimate_delay</a></span><span class="op">(</span></span>
<span>  reporting_triangle <span class="op">=</span> <span class="va">reporting_triangle</span>,</span>
<span>  max_delay <span class="op">=</span> <span class="va">max_delay</span>,</span>
<span>  n <span class="op">=</span> <span class="va">n_history_delay</span><span class="op">/</span><span class="fl">7</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">delay_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  delay <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">delay_pmf</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  pmf <span class="op">=</span> <span class="va">delay_pmf</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_cdf_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">delay_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Cumulative proportion reported"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Empirical point estimate of cumulative proportion reported by delay"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># nolint</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_pmf_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">delay_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="va">pmf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Proportion reported"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Empirical point estimate of proportion reported by delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Let’s plot the distribution of delays</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_cdf_plot</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_pmf_plot</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-8-2.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="apply-the-delay-to-generate-a-point-nowcast">Apply the delay to generate a point nowcast<a class="anchor" aria-label="anchor" href="#apply-the-delay-to-generate-a-point-nowcast"></a>
</h2>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">point_nowcast_matrix</span> <span class="op">&lt;-</span> <span class="fu">baselinenowcast</span><span class="fu">::</span><span class="fu"><a href="https://baselinenowcast.epinowcast.org/reference/apply_delay.html" class="external-link">apply_delay</a></span><span class="op">(</span></span>
<span>  reporting_triangle <span class="op">=</span> <span class="va">reporting_triangle</span>,</span>
<span>  delay_pmf <span class="op">=</span> <span class="va">delay_pmf</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">point_nowcast_df</span> <span class="op">&lt;-</span> <span class="va">eval_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>nowcast <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">point_nowcast_matrix</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prep_latest_data</span> <span class="op">&lt;-</span> <span class="va">latest_training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Real-time data"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">reference_date</span>, count <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span></span>
<span><span class="co"># Combine data into a single dataframe for plotting</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">point_nowcast_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">confirm</span>, <span class="va">nowcast</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"confirm"</span> <span class="op">~</span> <span class="st">"Final observed data"</span>,</span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"nowcast"</span> <span class="op">~</span> <span class="st">"Point nowcast"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">type</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">prep_latest_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create plot with data type as a variable</span></span>
<span><span class="va">plot_pt_nowcast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">reference_date</span>,</span>
<span>  y <span class="op">=</span> <span class="va">count</span>,</span>
<span>  color <span class="op">=</span> <span class="va">type</span>,</span>
<span>  linetype <span class="op">=</span> <span class="va">type</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Real-time data"</span> <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>    <span class="st">"Final observed data"</span> <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    <span class="st">"Point nowcast"</span> <span class="op">=</span> <span class="st">"darkblue"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Real-time data"</span> <span class="op">=</span> <span class="st">"dashed"</span>,</span>
<span>    <span class="st">"Final observed data"</span> <span class="op">=</span> <span class="st">"dashed"</span>,</span>
<span>    <span class="st">"Point nowcast"</span> <span class="op">=</span> <span class="st">"solid"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Confirmed admissions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#scale_y_continuous(trans = "log10") +</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparing real-time, nowcasted, and later observed cases"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"Type"</span>, linetype <span class="op">=</span> <span class="st">"Type"</span><span class="op">)</span></span>
<span><span class="va">plot_pt_nowcast</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>As you observe, this example is disappointing, as in this example the
point nowcast (blue) sits almost exactly on top of the real-time
observations (red). That behaviour aligns with the estimated delay
distribution, which places nearly all probability mass on a zero-week
delay for the most recent reference times.</p>
<p>Unfortunately, the NHSN signal currently exposed via Epidata only
stores revisions back to late 2024-11-17, so we cannot draw on a longer
training history to expose weeks with notable late reports.</p>
<p>Indeed, nowcasting is beneficial with a longer history of data
(unfortnuataly epidata does not store NHSN issues before 2024-11-17),
better nowcasting nodels.</p>
<p>To see larger adjustments, experiment with other locations, earlier
nowcast dates, or datasets that contain richer revision patterns (for
example the Robert Koch Institute line list available through the
Germany Nowcasting Hub).</p>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>Use <code><a href="https://baselinenowcast.epinowcast.org/reference/estimate_and_apply_uncertainty.html" class="external-link">baselinenowcast::estimate_and_apply_uncertainty()</a></code>
to obtain probabilistic nowcast intervals if you need calibrated
uncertainty estimates.</li>
<li>Adjust the training window (<code>n_training_weeks</code>) or
<code>max_delay</code> to match the reporting dynamics of other diseases
or locations.</li>
<li>Explore model variants documented in the <a href="https://baselinenowcast.epinowcast.org/articles/baselinenowcast.html" class="external-link">baselinenowcast
vignette</a> for stratified data or alternative delay models.</li>
</ul>
</div>
<div class="section level2">
<h2 id="a-more-interesting-example">a more interesting example<a class="anchor" aria-label="anchor" href="#a-more-interesting-example"></a>
</h2>
<p>This section follow closely the Getting started of the
baselinenowcast package</p>
<div class="section level3">
<h3 id="dataset">Dataset<a class="anchor" aria-label="anchor" href="#dataset"></a>
</h3>
<p>We will work on a more interesting dataset: daily level data from the
Robert Koch Institute via the Germany Nowcasting hub. These data
represent hospital admission counts by date of positive test and date of
test report in Germany up to October 1, 2021. Filter the data to just
look at the national-level data, for all age groups. We will pretend
that we are making a nowcast as of August 1, 2021, therefore we will
exclude all reference dates and report dates from before that date.
<code>germany_covid19_hosp</code> is provided as package data from
<code>epinowcast</code></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nowcast_date</span> <span class="op">&lt;-</span> <span class="st">"2021-08-01"</span></span>
<span><span class="va">eval_date</span> <span class="op">&lt;-</span> <span class="st">"2021-10-01"</span></span>
<span></span>
<span><span class="va">target_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="va"><a href="https://package.epinowcast.org/reference/germany_covid19_hosp.html" class="external-link">germany_covid19_hosp</a></span><span class="op">[</span><span class="va">location</span> <span class="op">==</span> <span class="st">"DE"</span><span class="op">]</span><span class="op">[</span><span class="va">age_group</span> <span class="op">==</span> <span class="st">"00+"</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">enw_filter_report_dates</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="va">eval_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">enw_filter_reference_dates</a></span><span class="op">(</span></span>
<span>    latest_date <span class="op">=</span> <span class="va">nowcast_date</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">latest_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">enw_latest_data</a></span><span class="op">(</span><span class="va">target_data</span><span class="op">)</span></span>
<span><span class="va">observed_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">enw_filter_report_dates</a></span><span class="op">(</span></span>
<span>  <span class="va">target_data</span>,</span>
<span>  latest_date <span class="op">=</span> <span class="va">nowcast_date</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    reference_date location age_group confirm report_date</span></span>
<span><span class="co">##            &lt;IDat&gt;   &lt;fctr&gt;    &lt;fctr&gt;   &lt;int&gt;      &lt;IDat&gt;</span></span>
<span><span class="co">## 1:     2021-04-06       DE       00+     149  2021-04-06</span></span>
<span><span class="co">## 2:     2021-04-07       DE       00+     312  2021-04-07</span></span>
<span><span class="co">## 3:     2021-04-08       DE       00+     424  2021-04-08</span></span>
<span><span class="co">## 4:     2021-04-09       DE       00+     288  2021-04-09</span></span>
<span><span class="co">## 5:     2021-04-10       DE       00+     273  2021-04-10</span></span>
<span><span class="co">## 6:     2021-04-11       DE       00+     107  2021-04-11</span></span></code></pre>
<details><summary>
Click to expand code to create the plot of the latest data
</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_data_by_reference_date</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">enw_latest_data</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">)</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">obs_data_by_reference_date</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"darkred"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">latest_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Confirmed admissions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparing real-time and later observed cases"</span><span class="op">)</span></span></code></pre></div>
</details><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="visualizing-all-versions-on-the-same-plot-germany-data">Visualizing all versions on the same plot (Germany data)<a class="anchor" aria-label="anchor" href="#visualizing-all-versions-on-the-same-plot-germany-data"></a>
</h3>
<p>Let’s create the same visualization for the Germany dataset, showing
all different report date versions in different colors.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get report dates - sample monthly to avoid too many versions</span></span>
<span><span class="va">all_report_dates_germany</span> <span class="op">&lt;-</span> <span class="va">target_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">report_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Select only the first day of each month (or closest available date)</span></span>
<span><span class="va">monthly_report_dates</span> <span class="op">&lt;-</span> <span class="va">all_report_dates_germany</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>year_month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">"%Y-%m"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">year_month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_min</a></span><span class="op">(</span><span class="va">date</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a dataframe with the latest data available as of each monthly report date</span></span>
<span><span class="co"># Using epinowcast::enw_latest_data() to properly get the latest value for each reference date</span></span>
<span><span class="va">all_versions_germany</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">monthly_report_dates</span>, <span class="kw">function</span><span class="op">(</span><span class="va">rd</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">target_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">enw_filter_report_dates</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="va">rd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">enw_latest_data</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">rd</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create plot with all versions in different colors</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all_versions_germany</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">confirm</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Confirmed admissions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"All Data Versions by Report Date (Germany COVID-19)"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Monthly snapshots showing how the data evolved over time"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Report Date"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_d</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>, end <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>        legend.key.height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/plot-all-versions-germany-1.png" width="700"></p>
<p>This visualization is much more interesting for the Germany dataset!
You can clearly see how the reported values evolved significantly over
time, with substantial revisions occurring as more complete data became
available.</p>
</div>
<div class="section level3">
<h3 id="lets-build-the-reporting-triangle">Let’s build the reporting triangle<a class="anchor" aria-label="anchor" href="#lets-build-the-reporting-triangle"></a>
</h3>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">max_delay</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span><span class="va">n_training_volume</span> <span class="op">&lt;-</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">max_delay</span></span>
<span><span class="va">n_history_delay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">n_training_volume</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">training_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">enw_filter_reference_dates</a></span><span class="op">(</span></span>
<span>  <span class="va">observed_data</span>,</span>
<span>  include_days <span class="op">=</span> <span class="va">n_training_volume</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">latest_training_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_latest_data.html" class="external-link">enw_latest_data</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span><span class="va">eval_data</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">enw_filter_reference_dates</a></span><span class="op">(</span></span>
<span>  <span class="va">latest_data</span>,</span>
<span>  include_days <span class="op">=</span> <span class="va">n_training_volume</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pobs</span> <span class="op">&lt;-</span> <span class="fu">epinowcast</span><span class="fu">::</span><span class="fu"><a href="https://package.epinowcast.org/reference/enw_preprocess_data.html" class="external-link">enw_preprocess_data</a></span><span class="op">(</span></span>
<span>  obs <span class="op">=</span> <span class="va">training_data</span>,</span>
<span>  max_delay <span class="op">=</span> <span class="va">max_delay</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">reporting_triangle_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>  <span class="va">pobs</span><span class="op">$</span><span class="va">new_confirm</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">reference_date</span>,</span>
<span>  <span class="va">delay</span>,</span>
<span>  <span class="va">new_confirm</span></span>
<span><span class="op">)</span></span>
<span><span class="va">reporting_triangle</span> <span class="op">&lt;-</span> <span class="va">reporting_triangle_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">delay</span>, values_from <span class="op">=</span> <span class="va">new_confirm</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<details><summary>
Click to expand code to create the plot of the reporting triangle
</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">triangle_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">reporting_triangle</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">time</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span>,</span>
<span>    names_prefix <span class="op">=</span> <span class="st">"V"</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"delay"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">delay</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_triangle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">triangle_df</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="va">time</span>, fill <span class="op">=</span> <span class="va">count</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Reporting triangle"</span>, x <span class="op">=</span> <span class="st">"Delay"</span>, y <span class="op">=</span> <span class="st">"Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</details><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_triangle</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-17-1.png" width="700">
Much more interesting !!</p>
</div>
<div class="section level3">
<h3 id="lets-estimate-the-delay">Let’s estimate the delay<a class="anchor" aria-label="anchor" href="#lets-estimate-the-delay"></a>
</h3>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_pmf</span> <span class="op">&lt;-</span> <span class="fu">estimate_delay</span><span class="op">(</span></span>
<span>  reporting_triangle <span class="op">=</span> <span class="va">reporting_triangle</span>,</span>
<span>  max_delay <span class="op">=</span> <span class="va">max_delay</span>,</span>
<span>  n <span class="op">=</span> <span class="va">n_history_delay</span></span>
<span><span class="op">)</span></span></code></pre></div>
<details><summary>
Click to expand code to create the plot of the delay distribution
</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  delay <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">delay_pmf</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  pmf <span class="op">=</span> <span class="va">delay_pmf</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_cdf_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">delay_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Cumulative proportion reported"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Empirical point estimate of cumulative proportion reported by delay"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># nolint</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_pmf_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">delay_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="va">pmf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Proportion reported"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Empirical point estimate of proportion reported by delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</details><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_cdf_plot</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_pmf_plot</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-20-2.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="generate-nowcast-with-delay">Generate nowcast with delay<a class="anchor" aria-label="anchor" href="#generate-nowcast-with-delay"></a>
</h3>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">point_nowcast_matrix</span> <span class="op">&lt;-</span> <span class="fu">baselinenowcast</span><span class="fu">::</span><span class="fu"><a href="https://baselinenowcast.epinowcast.org/reference/apply_delay.html" class="external-link">apply_delay</a></span><span class="op">(</span></span>
<span>  reporting_triangle <span class="op">=</span> <span class="va">reporting_triangle</span>,</span>
<span>  delay_pmf <span class="op">=</span> <span class="va">delay_pmf</span></span>
<span><span class="op">)</span></span></code></pre></div>
<details><summary>
Click to expand code to create the plot of the point nowcast
</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">point_nowcast_df</span> <span class="op">&lt;-</span> <span class="va">eval_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>nowcast <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">point_nowcast_matrix</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prep_latest_data</span> <span class="op">&lt;-</span> <span class="va">latest_training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Real-time data"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">reference_date</span>, count <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span></span>
<span><span class="co"># Combine data into a single dataframe for plotting</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">point_nowcast_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">confirm</span>, <span class="va">nowcast</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"confirm"</span> <span class="op">~</span> <span class="st">"Final observed data"</span>,</span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"nowcast"</span> <span class="op">~</span> <span class="st">"Point nowcast"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">type</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">prep_latest_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create plot with data type as a variable</span></span>
<span><span class="va">plot_pt_nowcast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">reference_date</span>,</span>
<span>  y <span class="op">=</span> <span class="va">count</span>,</span>
<span>  color <span class="op">=</span> <span class="va">type</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Real-time data"</span> <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>    <span class="st">"Final observed data"</span> <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    <span class="st">"Point nowcast"</span> <span class="op">=</span> <span class="st">"darkblue"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Confirmed admissions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparing real-time, nowcasted, and later observed cases"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"Type"</span><span class="op">)</span></span></code></pre></div>
</details><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_pt_nowcast</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="estimate-uncertainy">Estimate uncertainy<a class="anchor" aria-label="anchor" href="#estimate-uncertainy"></a>
</h3>
<p>For uncertainty estimation, we will generate retrospective nowcast
datasets with the most recent 50% of the reference times.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_retrospective_nowcasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">n_training_volume</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">trunc_rep_tri_list</span> <span class="op">&lt;-</span> <span class="fu">baselinenowcast</span><span class="fu">::</span><span class="fu"><a href="https://baselinenowcast.epinowcast.org/reference/truncate_triangles.html" class="external-link">truncate_triangles</a></span><span class="op">(</span><span class="va">reporting_triangle</span>,</span>
<span>  n <span class="op">=</span> <span class="va">n_retrospective_nowcasts</span></span>
<span><span class="op">)</span></span>
<span><span class="va">retro_rep_tri_list</span> <span class="op">&lt;-</span> <span class="fu">baselinenowcast</span><span class="fu">::</span><span class="fu"><a href="https://baselinenowcast.epinowcast.org/reference/construct_triangles.html" class="external-link">construct_triangles</a></span><span class="op">(</span><span class="va">trunc_rep_tri_list</span><span class="op">)</span></span>
<span></span>
<span><span class="va">retro_pt_nowcast_mat_list</span> <span class="op">&lt;-</span> <span class="fu">baselinenowcast</span><span class="fu">::</span><span class="fu"><a href="https://baselinenowcast.epinowcast.org/reference/fill_triangles.html" class="external-link">fill_triangles</a></span><span class="op">(</span></span>
<span>  retro_reporting_triangles <span class="op">=</span> <span class="va">retro_rep_tri_list</span>,</span>
<span>  n <span class="op">=</span> <span class="va">n_history_delay</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">disp_params</span> <span class="op">&lt;-</span> <span class="fu">baselinenowcast</span><span class="fu">::</span><span class="fu"><a href="https://baselinenowcast.epinowcast.org/reference/estimate_uncertainty.html" class="external-link">estimate_uncertainty</a></span><span class="op">(</span></span>
<span>  point_nowcast_matrices <span class="op">=</span> <span class="va">retro_pt_nowcast_mat_list</span>,</span>
<span>  truncated_reporting_triangles <span class="op">=</span> <span class="va">trunc_rep_tri_list</span>,</span>
<span>  retro_reporting_triangles <span class="op">=</span> <span class="va">retro_rep_tri_list</span>,</span>
<span>  n <span class="op">=</span> <span class="va">n_retrospective_nowcasts</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nowcast_draws_df</span> <span class="op">&lt;-</span> <span class="fu">baselinenowcast</span><span class="fu">::</span><span class="fu"><a href="https://baselinenowcast.epinowcast.org/reference/sample_nowcasts.html" class="external-link">sample_nowcasts</a></span><span class="op">(</span></span>
<span>  <span class="va">point_nowcast_matrix</span>, <span class="va">reporting_triangle</span>,</span>
<span>  uncertainty_params <span class="op">=</span> <span class="va">disp_params</span>,</span>
<span>  draws <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nowcast_draws_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   pred_count time draw</span></span>
<span><span class="co">## 1        736    1    1</span></span>
<span><span class="co">## 2        897    2    1</span></span>
<span><span class="co">## 3        893    3    1</span></span>
<span><span class="co">## 4        804    4    1</span></span>
<span><span class="co">## 5        722    5    1</span></span>
<span><span class="co">## 6        492    6    1</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="vizualize-probablistic-nowcast">Vizualize probablistic nowcast<a class="anchor" aria-label="anchor" href="#vizualize-probablistic-nowcast"></a>
</h3>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">latest_data_prepped</span> <span class="op">&lt;-</span> <span class="va">latest_training_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>obs_confirm <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>reference_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare the final evaluation data so we can combine the datasets.</span></span>
<span></span>
<span><span class="va">final_data_prepped</span> <span class="op">&lt;-</span> <span class="va">eval_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">reference_date</span>, final_confirm <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>reference_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Join the nowcasts, data as of the nowcast date, and the final data.</span></span>
<span><span class="va">obs_with_nowcast_draws_df</span> <span class="op">&lt;-</span> <span class="va">nowcast_draws_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">latest_data_prepped</span>, by <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">final_data_prepped</span>, by <span class="op">=</span> <span class="st">"reference_date"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">obs_with_nowcast_draws_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   pred_count time draw reference_date location age_group obs_confirm</span></span>
<span><span class="co">## 1        736    1    1     2021-05-04       DE       00+         823</span></span>
<span><span class="co">## 2        897    2    1     2021-05-05       DE       00+        1028</span></span>
<span><span class="co">## 3        893    3    1     2021-05-06       DE       00+        1016</span></span>
<span><span class="co">## 4        804    4    1     2021-05-07       DE       00+         892</span></span>
<span><span class="co">## 5        722    5    1     2021-05-08       DE       00+         822</span></span>
<span><span class="co">## 6        492    6    1     2021-05-09       DE       00+         561</span></span>
<span><span class="co">##   report_date final_confirm</span></span>
<span><span class="co">## 1  2021-07-24           823</span></span>
<span><span class="co">## 2  2021-07-25          1028</span></span>
<span><span class="co">## 3  2021-07-26          1016</span></span>
<span><span class="co">## 4  2021-07-27           892</span></span>
<span><span class="co">## 5  2021-07-28           822</span></span>
<span><span class="co">## 6  2021-07-29           561</span></span></code></pre>
<details><summary>
Click to expand code to create the plot of the probabilistic nowcast
</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a separate dataframe for only the observed and final data, to make plotting easier.</span></span>
<span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="va">obs_with_nowcast_draws_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">reference_date</span>, <span class="va">obs_confirm</span>, <span class="va">final_confirm</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">obs_confirm</span>, <span class="va">final_confirm</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"obs_confirm"</span> <span class="op">~</span> <span class="st">"Observed data"</span>,</span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"final_confirm"</span> <span class="op">~</span> <span class="st">"Final observed data"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Plot with draws for nowcast only</span></span>
<span><span class="va">plot_prob_nowcast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add nowcast draws as thin gray lines</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">obs_with_nowcast_draws_df</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">pred_count</span>, group <span class="op">=</span> <span class="va">draw</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"Nowcast draw"</span>, linewidth <span class="op">=</span> <span class="st">"Nowcast draw"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add observed data and final data once</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">combined_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">reference_date</span>,</span>
<span>      y <span class="op">=</span> <span class="va">count</span>,</span>
<span>      color <span class="op">=</span> <span class="va">type</span>,</span>
<span>      linewidth <span class="op">=</span> <span class="va">type</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Nowcast draw"</span> <span class="op">=</span> <span class="st">"gray"</span>,</span>
<span>      <span class="st">"Observed data"</span> <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>      <span class="st">"Final observed data"</span> <span class="op">=</span> <span class="st">"black"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linewidth_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Nowcast draw"</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>      <span class="st">"Observed data"</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      <span class="st">"Final observed data"</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hospital admissions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparison of admissions as of the nowcast date, later observed counts, \n and probabilistic nowcasted counts"</span><span class="op">)</span> <span class="co"># nolint</span></span></code></pre></div>
</details><div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_prob_nowcast</span></span></code></pre></div>
<p><img src="02.1-nowcasting-demo_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="more-ressources">More ressources:<a class="anchor" aria-label="anchor" href="#more-ressources"></a>
</h2>
<ul>
<li>Paulo Ventura’s archived NHSN exports: <a href="https://paulocv.github.io/respiratory_archive/" class="external-link uri">https://paulocv.github.io/respiratory_archive/</a>
</li>
<li>
<code>baselinenowcast</code> getting started guide: <a href="https://baselinenowcast.epinowcast.org/articles/baselinenowcast.html" class="external-link uri">https://baselinenowcast.epinowcast.org/articles/baselinenowcast.html</a>
(and the accompanying paper: <a href="https://www.medrxiv.org/content/10.1101/2025.08.14.25333653v2" class="external-link uri">https://www.medrxiv.org/content/10.1101/2025.08.14.25333653v2</a>)</li>
<li>
<code>epinowcast</code> introduction for principled hierarchical
nowcasting models: <a href="https://package.epinowcast.org/articles/epinowcast.html" class="external-link uri">https://package.epinowcast.org/articles/epinowcast.html</a>
</li>
<li>Delphi Insight Net Workshop 2024 slide decks (see the first two
sessions): <a href="https://cmu-delphi.github.io/insightnet-workshop-2024" class="external-link uri">https://cmu-delphi.github.io/insightnet-workshop-2024</a>.
Here the nowcasting is done using the scaling methods, but using another
set of software tools</li>
<li>SISMID NFIDD course notes on nowcasting: <a href="https://nfidd.github.io/sismid/" class="external-link uri">https://nfidd.github.io/sismid/</a>
</li>
<li>Lison et al. review of the nowcasting literature: <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1012021" class="external-link uri">https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1012021</a>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by ACCIDDA.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
