<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>4. Ensembling, Visualization, and Scoring Forecasting Outputs • AMPHForecastSuite</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="4. Ensembling, Visualization, and Scoring Forecasting Outputs">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">AMPHForecastSuite</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01-getting-started.html">1. Getting Started with AMPH Forecast Suite</a></li>
    <li><a class="dropdown-item" href="../articles/02-collect_empirical_data.html">2. Collect Empirical Data for Forecasting</a></li>
    <li><a class="dropdown-item" href="../articles/03-times-series-models.html">3. Forecasting with Time Series Models</a></li>
    <li><a class="dropdown-item" href="../articles/04-utilizing-hub-output.html">4. Ensembling, Visualization, and Scoring Forecasting Outputs</a></li>
    <li><a class="dropdown-item" href="../articles/05-convert_file_types.html">Other: Converting File Types</a></li>
    <li><a class="dropdown-item" href="../articles/nowcasting-demo.html">Other: Introduction to panel data versioning and nowcasting</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ACCIDDA/AMPH_Forecast_Suite/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="04-utilizing-hub-output_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="04-utilizing-hub-output_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><script src="04-utilizing-hub-output_files/plotly-binding-4.11.0/plotly.js"></script><script src="04-utilizing-hub-output_files/typedarray-0.1/typedarray.min.js"></script><link href="04-utilizing-hub-output_files/crosstalk-1.2.2/css/crosstalk.min.css" rel="stylesheet">
<script src="04-utilizing-hub-output_files/crosstalk-1.2.2/js/crosstalk.min.js"></script><link href="04-utilizing-hub-output_files/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="04-utilizing-hub-output_files/plotly-main-2.11.1/plotly-latest.min.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>4. Ensembling, Visualization, and Scoring Forecasting Outputs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ACCIDDA/AMPH_Forecast_Suite/blob/main/vignettes/04-utilizing-hub-output.Rmd" class="external-link"><code>vignettes/04-utilizing-hub-output.Rmd</code></a></small>
      <div class="d-none name"><code>04-utilizing-hub-output.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="set-parameters">0) Set parameters<a class="anchor" aria-label="anchor" href="#set-parameters"></a>
</h2>
</div>
<div class="section level2">
<h2 id="setup">1) Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>Install &amp; load required R packages</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ACCIDDA/AMPH_Forecast_Suite" class="external-link">AMPHForecastSuite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hubverse-org/hubEnsembles" class="external-link">hubEnsembles</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hubverse-org/hubUtils" class="external-link">hubUtils</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hubverse-org/hubVis" class="external-link">hubVis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://doi.org/10.48550/arXiv.2205.07090" class="external-link">scoringutils</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jeroen.r-universe.dev/jsonlite" class="external-link">jsonlite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">reference_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_reference_date.html">get_reference_date</a></span><span class="op">(</span><span class="va">forecast_date</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="get-flusight-data-repo">2) Get FluSight data repo<a class="anchor" aria-label="anchor" href="#get-flusight-data-repo"></a>
</h2>
<p>The FluSight Github repository stores forecast data for the FluSight
Influenza Forecasting Hub, run by the US CDC. This project collects
forecasts for weekly new hospitalizations due to confirmed influenza.
More information can be found in the ReadMe of the repository: <a href="https://github.com/cdcepi/FluSight-forecast-hub" class="external-link uri">https://github.com/cdcepi/FluSight-forecast-hub</a>.</p>
<p>We will copy a set of forecasts from this repository, and use them to
build a simple ensemble, visualize the forecasts, and score them against
observed data.</p>
<p>To switch to a different forecasting hub, change the
<code>disease</code> argument in the <code><a href="../reference/clone_hub_repos.html">clone_hub_repos()</a></code>
function below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">repo_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clone_hub_repos.html">clone_hub_repos</a></span><span class="op">(</span>disease <span class="op">=</span> <span class="va">forecast_disease</span>,</span>
<span>                            clone_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Cloning repository...</span></span></code></pre>
<pre><code><span><span class="co">## Cloning into 'FluSight-forecast-hub'...</span></span>
<span><span class="co">## Updating files:  37% (1004/2713)Updating files:  38% (1031/2713)Updating files:  39% (1059/2713)Updating files:  40% (1086/2713)Updating files:  41% (1113/2713)Updating files:  42% (1140/2713)Updating files:  43% (1167/2713)Updating files:  44% (1194/2713)Updating files:  45% (1221/2713)Updating files:  46% (1248/2713)Updating files:  47% (1276/2713)Updating files:  48% (1303/2713)Updating files:  49% (1330/2713)Updating files:  50% (1357/2713)Updating files:  51% (1384/2713)Updating files:  52% (1411/2713)Updating files:  53% (1438/2713)Updating files:  54% (1466/2713)Updating files:  55% (1493/2713)Updating files:  56% (1520/2713)Updating files:  57% (1547/2713)Updating files:  58% (1574/2713)Updating files:  59% (1601/2713)Updating files:  60% (1628/2713)Updating files:  61% (1655/2713)Updating files:  62% (1683/2713)Updating files:  63% (1710/2713)Updating files:  64% (1737/2713)Updating files:  65% (1764/2713)Updating files:  66% (1791/2713)Updating files:  67% (1818/2713)Updating files:  68% (1845/2713)Updating files:  69% (1872/2713)Updating files:  70% (1900/2713)Updating files:  71% (1927/2713)Updating files:  72% (1954/2713)Updating files:  73% (1981/2713)Updating files:  74% (2008/2713)Updating files:  75% (2035/2713)Updating files:  76% (2062/2713)Updating files:  77% (2090/2713)Updating files:  78% (2117/2713)Updating files:  79% (2144/2713)Updating files:  80% (2171/2713)Updating files:  81% (2198/2713)Updating files:  82% (2225/2713)Updating files:  83% (2252/2713)Updating files:  84% (2279/2713)Updating files:  85% (2307/2713)Updating files:  86% (2334/2713)Updating files:  87% (2361/2713)Updating files:  88% (2388/2713)Updating files:  89% (2415/2713)Updating files:  90% (2442/2713)Updating files:  91% (2469/2713)Updating files:  92% (2496/2713)Updating files:  93% (2524/2713)Updating files:  94% (2551/2713)Updating files:  95% (2578/2713)Updating files:  96% (2605/2713)Updating files:  97% (2632/2713)Updating files:  98% (2659/2713)Updating files:  98% (2677/2713)Updating files:  99% (2686/2713)Updating files: 100% (2713/2713)Updating files: 100% (2713/2713), done.</span></span></code></pre>
<pre><code><span><span class="co">## Using repo_dir: /home/runner/work/AMPH_Forecast_Suite/AMPH_Forecast_Suite/vignettes/FluSight-forecast-hub</span></span></code></pre>
<div class="section level4">
<h4 id="copy-specific-forecast-round-to-the-model-output-folder">Copy specific forecast round to the model-output folder<a class="anchor" aria-label="anchor" href="#copy-specific-forecast-round-to-the-model-output-folder"></a>
</h4>
<p>We will copy forecasts from a set of models from FluSight. These
include: # - FluSight-baseline # - MOBS-GLEAM_FLUH # -
FluSight-ensemble</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># models from flusight</span></span>
<span><span class="va">models_to_copy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"FluSight-baseline"</span>,</span>
<span>  <span class="st">"MOBS-GLEAM_FLUH"</span>,</span>
<span>  <span class="st">"FluSight-ensemble"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#models from AMPH</span></span>
<span><span class="va">models_created_in_AMPH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="st">"model-output"</span>, </span>
<span>                                    full.names <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                                    recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># copy Forecast Hub forecasts to model-output folder</span></span>
<span><span class="fu"><a href="../reference/copy_fch_outputs.html">copy_fch_outputs</a></span><span class="op">(</span><span class="va">repo_dir</span>,</span>
<span>                 <span class="va">reference_date</span>,</span>
<span>                 <span class="va">models_to_copy</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Copied files for date 2024-12-07 to /home/runner/work/AMPH_Forecast_Suite/AMPH_Forecast_Suite/vignettes/model-output</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="load-model-output-hub-forecasts-your-forecasts">4) Load model output (hub forecasts &amp; your forecasts)<a class="anchor" aria-label="anchor" href="#load-model-output-hub-forecasts-your-forecasts"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"model-output"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Retrieve parquet/csv model output files and keep those matching the reference date</span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">output_path</span>, pattern <span class="op">=</span> <span class="st">"\\.(parquet|csv)$"</span>,</span>
<span>                         full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="va">file_paths</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="va">reference_date</span>, <span class="va">file_paths</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">file_paths</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"No model-output files found for reference_date = "</span>, <span class="va">reference_date</span>,</span>
<span>       <span class="st">". Try a different date."</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Read &amp; bind; keep quantile forecasts; add model_id from folder name</span></span>
<span></span>
<span><span class="va">projection_data_all</span> <span class="op">&lt;-</span> <span class="va">file_paths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_model_file.html">read_model_file</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># standardize expected columns just in case</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="st">"output_type"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span>   <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Missing 'output_type' in: "</span>, <span class="va">.x</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="st">"output_type_id"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Missing 'output_type_id' in: "</span>, <span class="va">.x</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">output_type</span> <span class="op">==</span> <span class="st">"quantile"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        output_type_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">output_type_id</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        model_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">location</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prep_proj_data</span> <span class="op">&lt;-</span> <span class="va">projection_data_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    target_end_date <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">target_end_date</span>, <span class="va">reference_date</span> <span class="op">+</span> <span class="fl">7</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">horizon</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">any_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"model"</span>, <span class="st">"origin_date"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to hubverse model_out_tbl format</span></span>
<span><span class="va">projection_data_tbl</span> <span class="op">&lt;-</span> <span class="fu">hubUtils</span><span class="fu">::</span><span class="fu"><a href="https://hubverse-org.github.io/hubUtils/reference/as_model_out_tbl.html" class="external-link">as_model_out_tbl</a></span><span class="op">(</span><span class="va">prep_proj_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">models_created_in_AMPH</span>,</span>
<span>    <span class="va">models_to_copy</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Read and join location metadata (for names/abbreviations)</span></span>
<span></span>
<span><span class="co"># loc_data &lt;- readr::read_csv(file.path(dir_path, "auxiliary-data", "locations.csv"),</span></span>
<span><span class="co">#                             show_col_types = FALSE)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">loc_data</span>, package <span class="op">=</span> <span class="st">"AMPHForecastSuite"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">projection_data_tbl2</span> <span class="op">&lt;-</span> <span class="va">projection_data_tbl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">loc_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="va">abbreviation</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">location</span>, <span class="va">location_name</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>        <span class="va">loc_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">location</span>, <span class="va">location_name</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"location"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>location_name <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">location_name</span>, <span class="va">location</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">projection_data_tbl</span>, <span class="va">model_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">model_id</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">AMPH-epipredict-arx</td>
</tr>
<tr class="even">
<td align="left">AMPH-epipredict-climate</td>
</tr>
<tr class="odd">
<td align="left">AMPH-neuralnetwork</td>
</tr>
<tr class="even">
<td align="left">AMPH-sarima</td>
</tr>
<tr class="odd">
<td align="left">FluSight-baseline</td>
</tr>
<tr class="even">
<td align="left">FluSight-ensemble</td>
</tr>
<tr class="odd">
<td align="left">MOBS-GLEAM_FLUH</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="pick-location-start-date-and-uncertainty-bands">5) Pick location, start date, and uncertainty bands<a class="anchor" aria-label="anchor" href="#pick-location-start-date-and-uncertainty-bands"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Location can be "US" or a full state name (must match location_name in target_data)</span></span>
<span><span class="va">loc</span> <span class="op">&lt;-</span> <span class="va">state_name</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="co"># Middle 80% interval:</span></span>
<span><span class="va">uncertainty</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="build-a-simple-equal-weight-ensemble">6) Build a simple equal-weight ensemble<a class="anchor" aria-label="anchor" href="#build-a-simple-equal-weight-ensemble"></a>
</h2>
<p>We will use the <code><a href="https://hubverse-org.github.io/hubEnsembles/reference/simple_ensemble.html" class="external-link">simple_ensemble()</a></code> function from the
<code>hubEnsembles</code> package to build a simple, equal-weight
ensemble across a set of models. In this example, we exclude the
FluSight-baseline and FluSight-ensemble, and only ensemble for a single
location and forecast date.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Filter to the location of interest and the chosen forecast round</span></span>
<span><span class="va">round_dat</span> <span class="op">&lt;-</span> <span class="va">projection_data_tbl2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">location_name</span> <span class="op">==</span> <span class="va">loc</span>,</span>
<span>                <span class="va">target</span> <span class="op">==</span> <span class="va">target</span>,</span>
<span>                <span class="va">output_type</span> <span class="op">==</span> <span class="st">"quantile"</span>,</span>
<span>                <span class="va">horizon</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate a simple (equal-weight) ensemble across contributing models</span></span>
<span><span class="va">round_ens</span> <span class="op">&lt;-</span> <span class="fu">hubEnsembles</span><span class="fu">::</span><span class="fu"><a href="https://hubverse-org.github.io/hubEnsembles/reference/simple_ensemble.html" class="external-link">simple_ensemble</a></span><span class="op">(</span></span>
<span>  <span class="va">round_dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AMPH-SARIMA"</span>,<span class="st">"AMPH-neuralnetwork"</span>, <span class="st">"MOBS-GLEAM_FLUH"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="co"># dplyr::filter(!(model_id %in% c("FluSight-baseline", "AMPH-SARIMA","AMPH-neuralnetwork",</span></span>
<span>    <span class="co">#                                 "FluSight-ensemble",</span></span>
<span>    <span class="co">#                                 "AMPH-epipredict-climate")))) %&gt;%</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model_id <span class="op">=</span> <span class="st">"AMPH-ensemble"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine ensemble with individual models for plotting</span></span>
<span><span class="va">plot_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">round_dat</span>, <span class="va">round_ens</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># lapply(unique(round_dat$model_id), function(x){round_dat %&gt;% filter(model_id==x) %&gt;% pull(output_type_id) %&gt;% unique() %&gt;% length()})</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">plot_df</span><span class="op">$</span><span class="va">model_id</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "AMPH-epipredict-arx"     "AMPH-epipredict-climate"</span></span>
<span><span class="co">## [3] "AMPH-neuralnetwork"      "AMPH-sarima"            </span></span>
<span><span class="co">## [5] "FluSight-baseline"       "FluSight-ensemble"      </span></span>
<span><span class="co">## [7] "MOBS-GLEAM_FLUH"         "AMPH-ensemble"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="prepare-data-for-visualization">7) Prepare data for visualization<a class="anchor" aria-label="anchor" href="#prepare-data-for-visualization"></a>
</h2>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># pull updated target data</span></span>
<span><span class="va">new_target_data_date</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">+</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">weeks</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">target_data_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_nhsn_data.html">get_nhsn_data</a></span><span class="op">(</span></span>
<span>  disease <span class="op">=</span> <span class="va">forecast_disease</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="va">geo_ids</span>,</span>
<span>  forecast_date <span class="op">=</span> <span class="va">new_target_data_date</span>,</span>
<span>  save_data <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Important: forecast_date is more than 1 week ago. Pulling data issued prior to forecast_date.</span></span></code></pre>
<pre><code><span><span class="co">## Pulling data issued on or before 2025-01-11</span></span></code></pre>
<pre><code><span><span class="co">## Warning: No API key found. You will be limited to non-complex queries and encounter rate</span></span>
<span><span class="co">## limits if you proceed.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> See `?save_api_key()` for details on obtaining and setting API keys.</span></span>
<span><span class="co">## <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_data_plot</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"target-data"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"target-hospital-admissions-"</span>, <span class="va">new_target_data_date</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Forecasts to tidy plot</span></span>
<span><span class="va">proj_data</span> <span class="op">&lt;-</span> <span class="fu">hubUtils</span><span class="fu">::</span><span class="fu"><a href="https://hubverse-org.github.io/hubUtils/reference/as_model_out_tbl.html" class="external-link">as_model_out_tbl</a></span><span class="op">(</span><span class="va">plot_df</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>target_date <span class="op">=</span> <span class="va">target_end_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>output_type_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">output_type_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">model_id</span>, <span class="va">horizon</span>, <span class="va">target_date</span>, <span class="va">output_type_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">model_id</span>, <span class="va">horizon</span>, <span class="va">target_date</span>, <span class="va">output_type_id</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Observed data for the same location and time window</span></span>
<span><span class="va">target_data_plot</span> <span class="op">&lt;-</span> <span class="va">target_data_plot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target_end_date</span> <span class="op">&gt;</span> <span class="va">start_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">target_end_date</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">proj_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 10</span></span></span>
<span><span class="co">##   model_id      target_date reference_date target horizon location location_name</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> AMPH-ensemble 2024-12-07  2024-12-07     wk in…       0 24       Maryland     </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> AMPH-ensemble 2024-12-07  2024-12-07     wk in…       0 24       Maryland     </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> AMPH-ensemble 2024-12-07  2024-12-07     wk in…       0 24       Maryland     </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> AMPH-ensemble 2024-12-07  2024-12-07     wk in…       0 24       Maryland     </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> AMPH-ensemble 2024-12-07  2024-12-07     wk in…       0 24       Maryland     </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> AMPH-ensemble 2024-12-07  2024-12-07     wk in…       0 24       Maryland     </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 3 more variables: output_type &lt;chr&gt;, output_type_id &lt;dbl&gt;, value &lt;dbl&gt;</span></span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">target_data_plot</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 10</span></span></span>
<span><span class="co">##   location abbreviation location_name target    source disease signal date      </span></span>
<span><span class="co">##      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>       24 MD           Maryland      wk inc i… nhsn   influe… confi… 2024-09-21</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>       24 MD           Maryland      wk inc i… nhsn   influe… confi… 2024-09-28</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>       24 MD           Maryland      wk inc i… nhsn   influe… confi… 2024-10-05</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>       24 MD           Maryland      wk inc i… nhsn   influe… confi… 2024-10-12</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>       24 MD           Maryland      wk inc i… nhsn   influe… confi… 2024-10-19</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>       24 MD           Maryland      wk inc i… nhsn   influe… confi… 2024-10-26</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2 more variables: issue_date &lt;date&gt;, observation &lt;dbl&gt;</span></span></span></code></pre>
</div>
<div class="section level2">
<h2 id="plot-forecasts-vs--truth">8) Plot forecasts vs. truth<a class="anchor" aria-label="anchor" href="#plot-forecasts-vs--truth"></a>
</h2>
<p>We use two different approaches to visualize the forecasts
vs. observed data. The <code>hubVis</code> package provides a convenient
function to plot forecasts,
<code><a href="https://hubverse-org.github.io/hubVis/reference/plot_step_ahead_model_output.html" class="external-link">plot_step_ahead_model_output()</a></code>.</p>
<p>We can also plot <code>ggplot2</code> directly, though this requires
more code.</p>
<div class="section level3">
<h3 id="option-1-with-hubvis">Option 1: with <code>hubVis</code><a class="anchor" aria-label="anchor" href="#option-1-with-hubvis"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This is having issues</span></span>
<span></span>
<span><span class="fu">hubVis</span><span class="fu">::</span><span class="fu"><a href="https://hubverse-org.github.io/hubVis/reference/plot_step_ahead_model_output.html" class="external-link">plot_step_ahead_model_output</a></span><span class="op">(</span></span>
<span>  <span class="va">proj_data</span>,</span>
<span>  target_data <span class="op">=</span> <span class="va">target_data_plot</span>,</span>
<span>  use_median_as_point <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  show_legend <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  intervals <span class="op">=</span> <span class="fl">0.8</span>,        </span>
<span>  ens_name <span class="op">=</span> <span class="st">"AMPH-ensemble"</span>,</span>
<span>  ens_color <span class="op">=</span> <span class="st">"black"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="plotly html-widget html-fill-item" id="htmlwidget-e5c8c404fe174e4c81bd" style="width:864px;height:576px;"></div>
<script type="application/json" data-for="htmlwidget-e5c8c404fe174e4c81bd">{"x":{"visdat":{"254f449b55d1":["function () ","plotlyVisDat"],"254f51b2aab8":["function () ","data"],"254f792ceeee":["function () ","data"],"254f760d22b8":["function () ","data"],"254f25670aae":["function () ","data"],"254f3feff16a":["function () ","data"]},"cur_data":"254f3feff16a","attrs":{"254f51b2aab8":{"colors":"Set2","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":["2024-09-21","2024-09-28","2024-10-05","2024-10-12","2024-10-19","2024-10-26","2024-11-02","2024-11-09","2024-11-16","2024-11-23","2024-11-30","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2025-01-04"],"y":{},"type":"scatter","mode":"lines+markers","line":{"color":"#6e6e6e"},"hoverinfo":"text","name":"target","legendgroup":"target","hovertext":["Date: 2024-09-21<br>target:   5","Date: 2024-09-28<br>target:   1","Date: 2024-10-05<br>target:   1","Date: 2024-10-12<br>target:   0","Date: 2024-10-19<br>target:   2","Date: 2024-10-26<br>target:   0","Date: 2024-11-02<br>target:   4","Date: 2024-11-09<br>target:   9","Date: 2024-11-16<br>target:  11","Date: 2024-11-23<br>target:  16","Date: 2024-11-30<br>target:  20","Date: 2024-12-07<br>target:  37","Date: 2024-12-14<br>target:  73","Date: 2024-12-21<br>target: 131","Date: 2024-12-28<br>target: 178","Date: 2025-01-04<br>target: 367"],"marker":{"color":"#6e6e6e","size":7},"showlegend":true,"inherit":true},"254f792ceeee":{"colors":"Set2","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"y":{},"type":"scatter","mode":"lines","legendgroup":["AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-sarima","AMPH-sarima","AMPH-sarima","AMPH-sarima","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH"],"name":["AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-sarima","AMPH-sarima","AMPH-sarima","AMPH-sarima","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH"],"hoverinfo":"text","hovertext":["Date: 2024-12-07<br>Median: 18.51","Date: 2024-12-14<br>Median: 21.88","Date: 2024-12-21<br>Median: 24.89","Date: 2024-12-28<br>Median: 26.16","Date: 2024-12-07<br>Median: 18.51","Date: 2024-12-14<br>Median: 21.88","Date: 2024-12-21<br>Median: 24.89","Date: 2024-12-28<br>Median: 26.16","Date: 2024-12-07<br>Median: 18.00","Date: 2024-12-14<br>Median: 17.01","Date: 2024-12-21<br>Median: 16.02","Date: 2024-12-28<br>Median: 15.02","Date: 2024-12-07<br>Median: 18.83","Date: 2024-12-14<br>Median: 18.83","Date: 2024-12-21<br>Median: 18.83","Date: 2024-12-28<br>Median: 18.83","Date: 2024-12-07<br>Median: 19.00","Date: 2024-12-14<br>Median: 19.00","Date: 2024-12-21<br>Median: 19.00","Date: 2024-12-28<br>Median: 19.00","Date: 2024-12-07<br>Median: 25.00","Date: 2024-12-14<br>Median: 30.00","Date: 2024-12-21<br>Median: 37.00","Date: 2024-12-28<br>Median: 44.00","Date: 2024-12-07<br>Median: 24.06","Date: 2024-12-14<br>Median: 22.83","Date: 2024-12-21<br>Median: 22.00","Date: 2024-12-28<br>Median: 20.66"],"color":["AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-sarima","AMPH-sarima","AMPH-sarima","AMPH-sarima","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH"],"inherit":true},"254f760d22b8":{"colors":"Set2","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"ymin":{},"ymax":{},"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.25,"showlegend":false,"name":["AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-sarima","AMPH-sarima","AMPH-sarima","AMPH-sarima","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH"],"legendgroup":["AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-sarima","AMPH-sarima","AMPH-sarima","AMPH-sarima","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH"],"hoverinfo":"text","hovertext":["Date: 2024-12-07<br>80% Intervals:  7.40 -     NA","Date: 2024-12-14<br>80% Intervals:  5.68 -     NA","Date: 2024-12-21<br>80% Intervals:  6.13 -     NA","Date: 2024-12-28<br>80% Intervals:  4.01 -     NA","Date: 2024-12-07<br>80% Intervals:  7.40 -     NA","Date: 2024-12-14<br>80% Intervals:  5.68 -     NA","Date: 2024-12-21<br>80% Intervals:  6.13 -     NA","Date: 2024-12-28<br>80% Intervals:  4.01 -     NA","Date: 2024-12-07<br>80% Intervals:  6.97 -  39.95","Date: 2024-12-14<br>80% Intervals:  3.96 -  56.86","Date: 2024-12-21<br>80% Intervals:  2.38 -  81.64","Date: 2024-12-28<br>80% Intervals:  1.55 - 109.53","Date: 2024-12-07<br>80% Intervals:  6.03 -  43.15","Date: 2024-12-14<br>80% Intervals:  3.91 -  52.99","Date: 2024-12-21<br>80% Intervals:  2.62 -  62.02","Date: 2024-12-28<br>80% Intervals:  1.76 -  70.62","Date: 2024-12-07<br>80% Intervals:  0.00 -  55.00","Date: 2024-12-14<br>80% Intervals:  0.00 -  78.00","Date: 2024-12-21<br>80% Intervals:  0.00 -  90.00","Date: 2024-12-28<br>80% Intervals:  0.00 - 100.00","Date: 2024-12-07<br>80% Intervals: 13.00 -  38.00","Date: 2024-12-14<br>80% Intervals: 13.00 -  57.00","Date: 2024-12-21<br>80% Intervals: 13.00 -  74.00","Date: 2024-12-28<br>80% Intervals: 14.00 -  91.00","Date: 2024-12-07<br>80% Intervals: 15.52 -  36.99","Date: 2024-12-14<br>80% Intervals: 13.71 -  45.19","Date: 2024-12-21<br>80% Intervals: 11.69 -  55.49","Date: 2024-12-28<br>80% Intervals: 10.79 -  61.50"],"color":["AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-arx","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-epipredict-climate","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-neuralnetwork","AMPH-sarima","AMPH-sarima","AMPH-sarima","AMPH-sarima","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-baseline","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","FluSight-ensemble","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH","MOBS-GLEAM_FLUH"],"line":{"width":0},"inherit":true},"254f25670aae":{"colors":"Set2","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"y":{},"type":"scatter","mode":"lines","legendgroup":["AMPH-ensemble","AMPH-ensemble","AMPH-ensemble","AMPH-ensemble"],"name":["AMPH-ensemble","AMPH-ensemble","AMPH-ensemble","AMPH-ensemble"],"hoverinfo":"text","hovertext":["Date: 2024-12-07<br>Median: 21.03","Date: 2024-12-14<br>Median: 19.92","Date: 2024-12-21<br>Median: 19.01","Date: 2024-12-28<br>Median: 17.84"],"line":{"color":"black"},"inherit":true},"254f3feff16a":{"colors":"Set2","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"ymin":{},"ymax":{},"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.25,"showlegend":false,"name":["AMPH-ensemble","AMPH-ensemble","AMPH-ensemble","AMPH-ensemble"],"legendgroup":["AMPH-ensemble","AMPH-ensemble","AMPH-ensemble","AMPH-ensemble"],"hoverinfo":"text","hovertext":["Date: 2024-12-07<br>80% Intervals: 11.25 - 38.47","Date: 2024-12-14<br>80% Intervals:  8.84 - 51.03","Date: 2024-12-21<br>80% Intervals:  7.04 - 68.57","Date: 2024-12-28<br>80% Intervals:  6.17 - 85.51"],"fillcolor":"black","line":{"width":0,"color":"black"},"inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"xaxis":{"domain":[0,1],"automargin":true,"title":"Date"},"showlegend":true,"yaxis":{"domain":[0,1],"automargin":true,"title":"Value"},"hovermode":"closest"},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":["2024-09-21","2024-09-28","2024-10-05","2024-10-12","2024-10-19","2024-10-26","2024-11-02","2024-11-09","2024-11-16","2024-11-23","2024-11-30","2024-12-07","2024-12-14","2024-12-21","2024-12-28","2025-01-04"],"y":[5,1,1,0,2,0,4,9,11,16,20,37,73,131,178,367],"type":"scatter","mode":"lines+markers","line":{"color":"#6e6e6e"},"hoverinfo":["text","text","text","text","text","text","text","text","text","text","text","text","text","text","text","text"],"name":"target","legendgroup":"target","hovertext":["Date: 2024-09-21<br>target:   5","Date: 2024-09-28<br>target:   1","Date: 2024-10-05<br>target:   1","Date: 2024-10-12<br>target:   0","Date: 2024-10-19<br>target:   2","Date: 2024-10-26<br>target:   0","Date: 2024-11-02<br>target:   4","Date: 2024-11-09<br>target:   9","Date: 2024-11-16<br>target:  11","Date: 2024-11-23<br>target:  16","Date: 2024-11-30<br>target:  20","Date: 2024-12-07<br>target:  37","Date: 2024-12-14<br>target:  73","Date: 2024-12-21<br>target: 131","Date: 2024-12-28<br>target: 178","Date: 2025-01-04<br>target: 367"],"marker":{"color":"#6e6e6e","size":7,"line":{"color":"rgba(31,119,180,1)"}},"showlegend":true,"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"y":[18.513540277195855,21.876455828943321,24.887306612001353,26.155075308129256],"type":"scatter","mode":"lines","legendgroup":"AMPH-epipredict-arx","name":"AMPH-epipredict-arx","hoverinfo":["text","text","text","text"],"hovertext":["Date: 2024-12-07<br>Median: 18.51","Date: 2024-12-14<br>Median: 21.88","Date: 2024-12-21<br>Median: 24.89","Date: 2024-12-28<br>Median: 26.16"],"marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"y":[18.513540277195855,21.876455828943321,24.887306612001353,26.155075308129256],"type":"scatter","mode":"lines","legendgroup":"AMPH-epipredict-climate","name":"AMPH-epipredict-climate","hoverinfo":["text","text","text","text"],"hovertext":["Date: 2024-12-07<br>Median: 18.51","Date: 2024-12-14<br>Median: 21.88","Date: 2024-12-21<br>Median: 24.89","Date: 2024-12-28<br>Median: 26.16"],"marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"y":[18.003055638596653,17.010087857644752,16.018080100922454,15.023243150778397],"type":"scatter","mode":"lines","legendgroup":"AMPH-neuralnetwork","name":"AMPH-neuralnetwork","hoverinfo":["text","text","text","text"],"hovertext":["Date: 2024-12-07<br>Median: 18.00","Date: 2024-12-14<br>Median: 17.01","Date: 2024-12-21<br>Median: 16.02","Date: 2024-12-28<br>Median: 15.02"],"marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"y":[18.826807861610575,18.826807861610575,18.826807861610575,18.826807861610575],"type":"scatter","mode":"lines","legendgroup":"AMPH-sarima","name":"AMPH-sarima","hoverinfo":["text","text","text","text"],"hovertext":["Date: 2024-12-07<br>Median: 18.83","Date: 2024-12-14<br>Median: 18.83","Date: 2024-12-21<br>Median: 18.83","Date: 2024-12-28<br>Median: 18.83"],"marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"y":[19,19,19,19],"type":"scatter","mode":"lines","legendgroup":"FluSight-baseline","name":"FluSight-baseline","hoverinfo":["text","text","text","text"],"hovertext":["Date: 2024-12-07<br>Median: 19.00","Date: 2024-12-14<br>Median: 19.00","Date: 2024-12-21<br>Median: 19.00","Date: 2024-12-28<br>Median: 19.00"],"marker":{"color":"rgba(166,216,84,1)","line":{"color":"rgba(166,216,84,1)"}},"textfont":{"color":"rgba(166,216,84,1)"},"error_y":{"color":"rgba(166,216,84,1)"},"error_x":{"color":"rgba(166,216,84,1)"},"line":{"color":"rgba(166,216,84,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"y":[25,30,37,44],"type":"scatter","mode":"lines","legendgroup":"FluSight-ensemble","name":"FluSight-ensemble","hoverinfo":["text","text","text","text"],"hovertext":["Date: 2024-12-07<br>Median: 25.00","Date: 2024-12-14<br>Median: 30.00","Date: 2024-12-21<br>Median: 37.00","Date: 2024-12-28<br>Median: 44.00"],"marker":{"color":"rgba(255,217,47,1)","line":{"color":"rgba(255,217,47,1)"}},"textfont":{"color":"rgba(255,217,47,1)"},"error_y":{"color":"rgba(255,217,47,1)"},"error_x":{"color":"rgba(255,217,47,1)"},"line":{"color":"rgba(255,217,47,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"y":[24.059000000000001,22.832000000000001,22.004999999999999,20.661999999999999],"type":"scatter","mode":"lines","legendgroup":"MOBS-GLEAM_FLUH","name":"MOBS-GLEAM_FLUH","hoverinfo":["text","text","text","text"],"hovertext":["Date: 2024-12-07<br>Median: 24.06","Date: 2024-12-14<br>Median: 22.83","Date: 2024-12-21<br>Median: 22.00","Date: 2024-12-28<br>Median: 20.66"],"marker":{"color":"rgba(229,196,148,1)","line":{"color":"rgba(229,196,148,1)"}},"textfont":{"color":"rgba(229,196,148,1)"},"error_y":{"color":"rgba(229,196,148,1)"},"error_x":{"color":"rgba(229,196,148,1)"},"line":{"color":"rgba(229,196,148,1)"},"xaxis":"x","yaxis":"y","frame":null},{"fillcolor":"rgba(102,194,165,0.5)","x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-28","2024-12-21","2024-12-14","2024-12-07"],"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.25,"showlegend":false,"name":"AMPH-epipredict-arx","legendgroup":"AMPH-epipredict-arx","hoverinfo":["text","text","text","text","text","text","text","text"],"hovertext":["Date: 2024-12-07<br>80% Intervals:  7.40 -     NA","Date: 2024-12-14<br>80% Intervals:  5.68 -     NA","Date: 2024-12-21<br>80% Intervals:  6.13 -     NA","Date: 2024-12-28<br>80% Intervals:  4.01 -     NA","Date: 2024-12-28<br>80% Intervals:  4.01 -     NA","Date: 2024-12-21<br>80% Intervals:  6.13 -     NA","Date: 2024-12-14<br>80% Intervals:  5.68 -     NA","Date: 2024-12-07<br>80% Intervals:  7.40 -     NA"],"line":{"color":"rgba(102,194,165,1)","width":0},"y":[7.4005300697639012,5.675683132923055,6.1293686650908263,4.0066667437829651,null,null,null,null],"marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"fillcolor":"rgba(252,141,98,0.5)","x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-28","2024-12-21","2024-12-14","2024-12-07"],"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.25,"showlegend":false,"name":"AMPH-epipredict-climate","legendgroup":"AMPH-epipredict-climate","hoverinfo":["text","text","text","text","text","text","text","text"],"hovertext":["Date: 2024-12-07<br>80% Intervals:  7.40 -     NA","Date: 2024-12-14<br>80% Intervals:  5.68 -     NA","Date: 2024-12-21<br>80% Intervals:  6.13 -     NA","Date: 2024-12-28<br>80% Intervals:  4.01 -     NA","Date: 2024-12-28<br>80% Intervals:  4.01 -     NA","Date: 2024-12-21<br>80% Intervals:  6.13 -     NA","Date: 2024-12-14<br>80% Intervals:  5.68 -     NA","Date: 2024-12-07<br>80% Intervals:  7.40 -     NA"],"line":{"color":"rgba(252,141,98,1)","width":0},"y":[7.4005300697639012,5.675683132923055,6.1293686650908263,4.0066667437829651,null,null,null,null],"marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"fillcolor":"rgba(141,160,203,0.5)","x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-28","2024-12-21","2024-12-14","2024-12-07"],"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.25,"showlegend":false,"name":"AMPH-neuralnetwork","legendgroup":"AMPH-neuralnetwork","hoverinfo":["text","text","text","text","text","text","text","text"],"hovertext":["Date: 2024-12-07<br>80% Intervals:  6.97 -  39.95","Date: 2024-12-14<br>80% Intervals:  3.96 -  56.86","Date: 2024-12-21<br>80% Intervals:  2.38 -  81.64","Date: 2024-12-28<br>80% Intervals:  1.55 - 109.53","Date: 2024-12-28<br>80% Intervals:  1.55 - 109.53","Date: 2024-12-21<br>80% Intervals:  2.38 -  81.64","Date: 2024-12-14<br>80% Intervals:  3.96 -  56.86","Date: 2024-12-07<br>80% Intervals:  6.97 -  39.95"],"line":{"color":"rgba(141,160,203,1)","width":0},"y":[6.9717731815779977,3.964389414083533,2.3785986577780891,1.5539474479637696,109.52624475787208,81.641521581029224,56.861308053527509,39.949567678332883],"marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"fillcolor":"rgba(231,138,195,0.5)","x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-28","2024-12-21","2024-12-14","2024-12-07"],"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.25,"showlegend":false,"name":"AMPH-sarima","legendgroup":"AMPH-sarima","hoverinfo":["text","text","text","text","text","text","text","text"],"hovertext":["Date: 2024-12-07<br>80% Intervals:  6.03 -  43.15","Date: 2024-12-14<br>80% Intervals:  3.91 -  52.99","Date: 2024-12-21<br>80% Intervals:  2.62 -  62.02","Date: 2024-12-28<br>80% Intervals:  1.76 -  70.62","Date: 2024-12-28<br>80% Intervals:  1.76 -  70.62","Date: 2024-12-21<br>80% Intervals:  2.62 -  62.02","Date: 2024-12-14<br>80% Intervals:  3.91 -  52.99","Date: 2024-12-07<br>80% Intervals:  6.03 -  43.15"],"line":{"color":"rgba(231,138,195,1)","width":0},"y":[6.0252195350255731,3.9110399556515811,2.6162139772632096,1.7612364245674883,70.622070446706914,62.02421147642773,52.993409165935624,43.150068368084682],"marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null},{"fillcolor":"rgba(166,216,84,0.5)","x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-28","2024-12-21","2024-12-14","2024-12-07"],"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.25,"showlegend":false,"name":"FluSight-baseline","legendgroup":"FluSight-baseline","hoverinfo":["text","text","text","text","text","text","text","text"],"hovertext":["Date: 2024-12-07<br>80% Intervals:  0.00 -  55.00","Date: 2024-12-14<br>80% Intervals:  0.00 -  78.00","Date: 2024-12-21<br>80% Intervals:  0.00 -  90.00","Date: 2024-12-28<br>80% Intervals:  0.00 - 100.00","Date: 2024-12-28<br>80% Intervals:  0.00 - 100.00","Date: 2024-12-21<br>80% Intervals:  0.00 -  90.00","Date: 2024-12-14<br>80% Intervals:  0.00 -  78.00","Date: 2024-12-07<br>80% Intervals:  0.00 -  55.00"],"line":{"color":"rgba(166,216,84,1)","width":0},"y":[0,0,0,0,100,90,78,55],"marker":{"color":"rgba(166,216,84,1)","line":{"color":"rgba(166,216,84,1)"}},"textfont":{"color":"rgba(166,216,84,1)"},"error_y":{"color":"rgba(166,216,84,1)"},"error_x":{"color":"rgba(166,216,84,1)"},"xaxis":"x","yaxis":"y","frame":null},{"fillcolor":"rgba(255,217,47,0.5)","x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-28","2024-12-21","2024-12-14","2024-12-07"],"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.25,"showlegend":false,"name":"FluSight-ensemble","legendgroup":"FluSight-ensemble","hoverinfo":["text","text","text","text","text","text","text","text"],"hovertext":["Date: 2024-12-07<br>80% Intervals: 13.00 -  38.00","Date: 2024-12-14<br>80% Intervals: 13.00 -  57.00","Date: 2024-12-21<br>80% Intervals: 13.00 -  74.00","Date: 2024-12-28<br>80% Intervals: 14.00 -  91.00","Date: 2024-12-28<br>80% Intervals: 14.00 -  91.00","Date: 2024-12-21<br>80% Intervals: 13.00 -  74.00","Date: 2024-12-14<br>80% Intervals: 13.00 -  57.00","Date: 2024-12-07<br>80% Intervals: 13.00 -  38.00"],"line":{"color":"rgba(255,217,47,1)","width":0},"y":[13,13,13,14,91,74,57,38],"marker":{"color":"rgba(255,217,47,1)","line":{"color":"rgba(255,217,47,1)"}},"textfont":{"color":"rgba(255,217,47,1)"},"error_y":{"color":"rgba(255,217,47,1)"},"error_x":{"color":"rgba(255,217,47,1)"},"xaxis":"x","yaxis":"y","frame":null},{"fillcolor":"rgba(229,196,148,0.5)","x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-28","2024-12-28","2024-12-21","2024-12-14","2024-12-07"],"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.25,"showlegend":false,"name":"MOBS-GLEAM_FLUH","legendgroup":"MOBS-GLEAM_FLUH","hoverinfo":["text","text","text","text","text","text","text","text","text"],"hovertext":["Date: 2024-12-07<br>80% Intervals: 15.52 -  36.99","Date: 2024-12-14<br>80% Intervals: 13.71 -  45.19","Date: 2024-12-21<br>80% Intervals: 11.69 -  55.49","Date: 2024-12-28<br>80% Intervals: 10.79 -  61.50","Date: 2024-12-28<br>80% Intervals: 10.79 -  61.50","Date: 2024-12-28<br>80% Intervals: 10.79 -  61.50","Date: 2024-12-21<br>80% Intervals: 11.69 -  55.49","Date: 2024-12-14<br>80% Intervals: 13.71 -  45.19","Date: 2024-12-07<br>80% Intervals: 15.52 -  36.99"],"line":{"color":"rgba(229,196,148,1)","width":0},"y":[15.522,13.706,11.692,10.785,10.785,61.502000000000002,55.488999999999997,45.189999999999998,36.988],"marker":{"color":"rgba(229,196,148,1)","line":{"color":"rgba(229,196,148,1)"}},"textfont":{"color":"rgba(229,196,148,1)"},"error_y":{"color":"rgba(229,196,148,1)"},"error_x":{"color":"rgba(229,196,148,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28"],"y":[21.031027819298327,19.921043928822378,19.011540050461228,17.842621575389199],"type":"scatter","mode":"lines","legendgroup":"AMPH-ensemble","name":"AMPH-ensemble","hoverinfo":["text","text","text","text"],"hovertext":["Date: 2024-12-07<br>Median: 21.03","Date: 2024-12-14<br>Median: 19.92","Date: 2024-12-21<br>Median: 19.01","Date: 2024-12-28<br>Median: 17.84"],"line":{"color":"black"},"marker":{"color":"rgba(140,86,75,1)","line":{"color":"rgba(140,86,75,1)"}},"error_y":{"color":"rgba(140,86,75,1)"},"error_x":{"color":"rgba(140,86,75,1)"},"xaxis":"x","yaxis":"y","frame":null},{"fillcolor":"black","x":["2024-12-07","2024-12-14","2024-12-21","2024-12-28","2024-12-28","2024-12-28","2024-12-21","2024-12-14","2024-12-07"],"type":"scatter","mode":"lines","hoveron":"points","fill":"toself","opacity":0.25,"showlegend":false,"name":"AMPH-ensemble","legendgroup":"AMPH-ensemble","hoverinfo":["text","text","text","text","text","text","text","text","text"],"hovertext":["Date: 2024-12-07<br>80% Intervals: 11.25 - 38.47","Date: 2024-12-14<br>80% Intervals:  8.84 - 51.03","Date: 2024-12-21<br>80% Intervals:  7.04 - 68.57","Date: 2024-12-28<br>80% Intervals:  6.17 - 85.51","Date: 2024-12-28<br>80% Intervals:  6.17 - 85.51","Date: 2024-12-28<br>80% Intervals:  6.17 - 85.51","Date: 2024-12-21<br>80% Intervals:  7.04 - 68.57","Date: 2024-12-14<br>80% Intervals:  8.84 - 51.03","Date: 2024-12-07<br>80% Intervals: 11.25 - 38.47"],"line":{"color":"black","width":0},"y":[11.246886590789,8.8351947070417669,7.0352993288890442,6.1694737239818851,6.1694737239818851,85.514122378936037,68.565260790514614,51.025654026763753,38.468783839166441],"marker":{"color":"rgba(227,119,194,1)","line":{"color":"rgba(227,119,194,1)"}},"error_y":{"color":"rgba(227,119,194,1)"},"error_x":{"color":"rgba(227,119,194,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level3">
<h3 id="option-2-with-ggplot2">Option 2: with <code>ggplot2</code><a class="anchor" aria-label="anchor" href="#option-2-with-ggplot2"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># target_data_plot &lt;- readr::read_csv(</span></span>
<span><span class="co">#   file.path("target-data", paste0("target-hospital-admissions-", new_target_data_date, ".csv")),</span></span>
<span><span class="co">#   show_col_types = FALSE)</span></span>
<span></span>
<span><span class="co"># Identify ensemble id from the object you created earlier</span></span>
<span><span class="va">ens_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">round_ens</span><span class="op">$</span><span class="va">model_id</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>  <span class="co"># e.g., "hub-ensemble"</span></span>
<span></span>
<span><span class="co"># Build the 80% ribbon (0.1 / 0.9) for all models</span></span>
<span><span class="va">ribbon_80</span> <span class="op">&lt;-</span> <span class="va">proj_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">output_type</span> <span class="op">==</span> <span class="st">"quantile"</span>, <span class="va">output_type_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>output_type_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">output_type_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">model_id</span>, <span class="va">horizon</span>, <span class="va">target_date</span>, <span class="va">output_type_id</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">output_type_id</span>, values_from <span class="op">=</span> <span class="va">value</span>, names_prefix <span class="op">=</span> <span class="st">"q"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">q0.1</span>, ymax <span class="op">=</span> <span class="va">q0.9</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Median (0.5) for all models</span></span>
<span><span class="va">med_50</span> <span class="op">&lt;-</span> <span class="va">proj_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">output_type</span> <span class="op">==</span> <span class="st">"quantile"</span>, <span class="va">output_type_id</span> <span class="op">==</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">model_id</span>, <span class="va">horizon</span>, <span class="va">target_date</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>line_width <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">model_id</span> <span class="op">==</span> <span class="va">ens_id</span>, <span class="fl">1.1</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Legend order: others first, ensemble last</span></span>
<span><span class="va">model_levels</span> <span class="op">&lt;-</span> <span class="va">proj_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">model_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">model_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">ens_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ens_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Okabe–Ito palette (color-blind friendly)</span></span>
<span><span class="va">okabe_ito</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>,</span>
<span>  <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span>, <span class="st">"#999999"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">n_other</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">model_levels</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="va">other_cols</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">n_other</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">okabe_ito</span><span class="op">)</span><span class="op">)</span> <span class="va">okabe_ito</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_other</span><span class="op">)</span><span class="op">]</span> <span class="kw">else</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pal_hue.html" class="external-link">hue_pal</a></span><span class="op">(</span>l <span class="op">=</span> <span class="fl">45</span>, c <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">(</span><span class="va">n_other</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Lines: others = Okabe–Ito, ensemble = black</span></span>
<span><span class="va">color_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">other_cols</span>, <span class="st">"#000000"</span><span class="op">)</span>, <span class="va">model_levels</span><span class="op">)</span></span>
<span><span class="co"># Ribbons: same hues; ensemble darker gray so black line pops</span></span>
<span><span class="va">fill_vals</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">other_cols</span>, <span class="st">"#3A3A3A"</span><span class="op">)</span>, <span class="va">model_levels</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">ribbon_80</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, ymin <span class="op">=</span> <span class="va">ymin</span>, ymax <span class="op">=</span> <span class="va">ymax</span>, fill <span class="op">=</span> <span class="va">model_id</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.22</span>, show.legend <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">med_50</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">model_id</span>, linewidth <span class="op">=</span> <span class="va">line_width</span><span class="op">)</span>,</span>
<span>    lineend <span class="op">=</span> <span class="st">"round"</span>, alpha <span class="op">=</span> <span class="fl">0.98</span>, show.legend <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">target_data_plot</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">observation</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">1.2</span>, alpha <span class="op">=</span> <span class="fl">0.85</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey50"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">target_data_plot</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">observation</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.85</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey50"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">color_vals</span>, name <span class="op">=</span> <span class="st">"Model"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values  <span class="op">=</span> <span class="va">fill_vals</span>,  name <span class="op">=</span> <span class="st">"Model"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_identity.html" class="external-link">scale_linewidth_identity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Target date"</span>, y <span class="op">=</span> <span class="st">"Weekly incident hospitalizations"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 8 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">## (`geom_ribbon()`).</span></span></code></pre>
<p><img src="04-utilizing-hub-output_files/figure-html/plot-opt2-ggplot-1.png" alt="Plot of forecasts vs. truth" width="864"></p>
</div>
</div>
<div class="section level2">
<h2 id="score-forecasts-wis-coverage">10) Score forecasts (WIS, coverage)<a class="anchor" aria-label="anchor" href="#score-forecasts-wis-coverage"></a>
</h2>
<p>Evaluation of forecasts is critical for assessing model performance
and for building trust in forecasts. Proper scoring rules, such as the
Weighted Interval Score (WIS), provide a way to evaluate the accuracy
and calibration of probabilistic forecasts. Scoring requires observed
data. We will use the <code>scoringutils</code> package to compute WIS
for our forecasts.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scoring_target_data</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"target-data"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"target-hospital-admissions-"</span>, <span class="va">new_target_data_date</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scoring_target_data</span> <span class="op">&lt;-</span> <span class="va">scoring_target_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">location</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">location</span>,</span>
<span>         <span class="va">issue_date</span> <span class="op">&gt;=</span> <span class="va">target_end_date</span> <span class="op">+</span> <span class="fl">28</span>,</span>
<span>         <span class="va">target_end_date</span> <span class="op">&gt;</span> <span class="st">"2022-09-01"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>geo_value <span class="op">=</span> <span class="va">location</span>, <span class="va">target_end_date</span>, value <span class="op">=</span> <span class="va">observation</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">epiprocess</span><span class="fu">::</span><span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_df.html" class="external-link">as_epi_df</a></span><span class="op">(</span>time_value <span class="op">=</span> <span class="va">target_end_date</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Join forecasts with observations at (target_date, location)</span></span>
<span><span class="co"># and conform to scoringutils "forecast" structure.</span></span>
<span></span>
<span><span class="va">scoring_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">proj_data</span>,</span>
<span>  <span class="va">scoring_target_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>observation <span class="op">=</span> <span class="va">value</span>,</span>
<span>                  target_date <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>location_name <span class="op">=</span> <span class="st">"Maryland"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">geo_value</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"target_date"</span>, <span class="st">"location_name"</span><span class="op">)</span>,</span>
<span>  relationship <span class="op">=</span> <span class="st">"many-to-one"</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">model_id</span>,</span>
<span>    predicted <span class="op">=</span> <span class="va">value</span>,</span>
<span>    observed <span class="op">=</span> <span class="va">observation</span>,</span>
<span>    quantile_level <span class="op">=</span> <span class="va">output_type_id</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to a scoringutils forecast object</span></span>
<span><span class="va">forecast</span> <span class="op">&lt;-</span> <span class="fu">scoringutils</span><span class="fu">::</span><span class="fu"><a href="https://epiforecasts.io/scoringutils/reference/as_forecast_quantile.html" class="external-link">as_forecast_quantile</a></span><span class="op">(</span></span>
<span>  <span class="va">scoring_df</span>,</span>
<span>  observed       <span class="op">=</span> <span class="st">"observed"</span>,</span>
<span>  predicted      <span class="op">=</span> <span class="st">"predicted"</span>,</span>
<span>  quantile_level <span class="op">=</span> <span class="st">"quantile_level"</span>,</span>
<span>  <span class="co"># be explicit so extra cols don't confuse the unit of a single forecast</span></span>
<span>  forecast_unit  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"model"</span>, <span class="st">"location_name"</span>, <span class="st">"target_date"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: The `quantile_level` column in your data seems to have a rounding issue (run</span></span>
<span><span class="co">## `diff(sort(unique(data$quantile_level)))` to see this. As `scoringutils` does</span></span>
<span><span class="co">## not support arbitrarily fine quantile level increments, we're going to run</span></span>
<span><span class="co">## `round(x, digits = 10)` on the `quantile_level` column.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Some rows containing NA values may be removed. This is fine if not</span></span>
<span><span class="co">##   unexpected.</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Score (WIS, coverage, etc.)</span></span>
<span><span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu">scoringutils</span><span class="fu">::</span><span class="fu"><a href="https://epiforecasts.io/scoringutils/reference/score.html" class="external-link">score</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu">scoringutils</span><span class="fu">::</span><span class="fu"><a href="https://epiforecasts.io/scoringutils/reference/summarise_scores.html" class="external-link">summarise_scores</a></span><span class="op">(</span><span class="va">scores</span>, by <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="18%">
<col width="7%">
<col width="11%">
<col width="12%">
<col width="8%">
<col width="3%">
<col width="15%">
<col width="15%">
<col width="7%">
</colgroup>
<thead><tr class="header">
<th align="left">model</th>
<th align="right">wis</th>
<th align="right">overprediction</th>
<th align="right">underprediction</th>
<th align="right">dispersion</th>
<th align="right">bias</th>
<th align="right">interval_coverage_50</th>
<th align="right">interval_coverage_90</th>
<th align="right">ae_median</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">AMPH-ensemble</td>
<td align="right">8.763409</td>
<td align="right">0</td>
<td align="right">6.643904</td>
<td align="right">2.119505</td>
<td align="right">-0.8</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">15.96897</td>
</tr>
<tr class="even">
<td align="left">AMPH-epipredict-arx</td>
<td align="right">12.173837</td>
<td align="right">0</td>
<td align="right">10.582491</td>
<td align="right">1.591347</td>
<td align="right">-0.9</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">18.48646</td>
</tr>
<tr class="odd">
<td align="left">AMPH-epipredict-climate</td>
<td align="right">12.173837</td>
<td align="right">0</td>
<td align="right">10.582491</td>
<td align="right">1.591347</td>
<td align="right">-0.9</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">18.48646</td>
</tr>
<tr class="even">
<td align="left">AMPH-neuralnetwork</td>
<td align="right">10.299610</td>
<td align="right">0</td>
<td align="right">7.758374</td>
<td align="right">2.541236</td>
<td align="right">-0.8</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">18.99694</td>
</tr>
<tr class="odd">
<td align="left">AMPH-sarima</td>
<td align="right">9.365111</td>
<td align="right">0</td>
<td align="right">6.322820</td>
<td align="right">3.042291</td>
<td align="right">-0.7</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">18.17319</td>
</tr>
<tr class="even">
<td align="left">FluSight-baseline</td>
<td align="right">10.820000</td>
<td align="right">0</td>
<td align="right">8.000000</td>
<td align="right">2.820000</td>
<td align="right">-0.8</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">18.00000</td>
</tr>
<tr class="odd">
<td align="left">FluSight-ensemble</td>
<td align="right">6.641304</td>
<td align="right">0</td>
<td align="right">4.434783</td>
<td align="right">2.206522</td>
<td align="right">-0.8</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">12.00000</td>
</tr>
<tr class="even">
<td align="left">MOBS-GLEAM_FLUH</td>
<td align="right">7.228252</td>
<td align="right">0</td>
<td align="right">5.530478</td>
<td align="right">1.697774</td>
<td align="right">-0.9</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">12.94100</td>
</tr>
</tbody>
</table>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by ACCIDDA.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
